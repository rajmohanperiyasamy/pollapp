{% extends "admin/admin_base.html" %}
{% load tabs %}
{% load i18n %}
{% load get_example %}
{% block navigation %}
    {% activetab 'topnav' 'config' %}
    {{ block.super }}
{% endblock %}
{% block pagetitle %}{% trans 'Payment' %} {% endblock %}
{% block head %}
<script type="text/javascript" src="{{STATIC_URL}}js/jquery/bm.common.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/jquery/jquery.validate.min.js"></script>
<script type="text/javascript">
var valid=false;
$(document).ready(function(){
    $(":input[type='text']").live("keyup",function(e){if(valid){custom_validate();}});
    $(":input[type='checkbox']").live("change",function(e){if(valid){custom_validate();}});

    fun_fb_disable();
    fun_tw_disable();
	fun_au_disable();
	fun_sp_disable();

    $("#mform").validate({
        highlight: function(element, errorClass){$(element).parent('div').parent('div').addClass('field-error');$(element).addClass('error');$(element).addClass('error');},
        unhighlight: function(element, errorClass){$(element).parent('div').parent('div').removeClass('field-error');$(element).removeClass('error');$(element).removeClass('error');},
        errorPlacement: function(error, element){},
           rules:{
            currency_symbol:"required",
            currency_code:"required",
            paypal_receiver_email:{
                required:false,
                email:true
            }
           }
    });
});
function fun_fb_disable(){
    if($("#id_paypal_payment").prop("checked")){
        $('#id_paypal_receiver_email').removeAttr('disabled','disabled');
    }else{
        $('#id_paypal_receiver_email').attr('disabled','disabled');
    }
    //custom_validate();
}
function fun_tw_disable(){
    if($("#id_google_checkout").prop("checked")){
        $('#id_merchant_id').removeAttr('disabled','disabled');
        $('#id_merchant_key').removeAttr('disabled','disabled');
    }else{
        $('#id_merchant_id').attr('disabled','disabled');
        $('#id_merchant_key').attr('disabled','disabled');
    }
    //custom_validate();
}
function fun_au_disable(){
	if($("#id_authorize").prop("checked")){
		$('#id_login_id').removeAttr('disabled','disabled');
		$('#id_transaction_key').removeAttr('disabled','disabled');
	}else{
		$('#id_login_id').attr('disabled','disabled');
		$('#id_transaction_key').attr('disabled','disabled');
	}
	//custom_validate();
}
function fun_sp_disable(){
    if($("#id_stripe").prop("checked")){
        $('#id_stripe_public_key').removeAttr('disabled','disabled');
        $('#id_stripe_private_key').removeAttr('disabled','disabled');
    }else{
        $('#id_stripe_public_key').attr('disabled','disabled');
        $('#id_stripe_private_key').attr('disabled','disabled');
    }
    //custom_validate();
}
function custom_validate(){
    var flag1=true;
    var flag2=true;
	var flag3=true;
	var flag4=true;
    var flag = $('#mform').validate().form();
    if(flag){
        if($('#id_paypal_payment').is(':checked') || $('#id_google_checkout').is(':checked') || $('#id_authorize').is(':checked') || $('#id_stripe').is(':checked')){
            if($('#id_paypal_payment').is(':checked')){
                if($('#id_paypal_receiver_email').val()!=""){
                    removeerror($('#id_paypal_payment'));
                    removeerror($('#id_paypal_receiver_email'));
                    flag1=true;
                }
                else{
                    flag1=false;
                    adderror($('#id_paypal_receiver_email'));
                }
            }else{
                removeerror($('#id_paypal_payment'));
                removeerror($('#id_paypal_receiver_email'));
            }
            if($('#id_google_checkout').is(':checked')){
                if($('#id_merchant_id').val()!="" && $('#id_merchant_key').val()!=""){
                    removeerror($('#id_google_checkout'));
                    removeerror($('#id_merchant_id'));
                    removeerror($('#id_merchant_key'));
                    flag2=true;
                }
                else{
                    flag2=false;
                    if($('#id_merchant_id').val()=="" ){adderror($('#id_merchant_id'));}
                    if($('#id_merchant_key').val()=="" ){adderror($('#id_merchant_key'));}
                }
            }else{
                removeerror($('#id_merchant_id'));
                removeerror($('#id_merchant_key'));
            }
			if($('#id_authorize').is(':checked')){
                if($('#id_login_id').val()!="" && $('#id_transaction_key').val()!=""){
                    removeerror($('#id_authorize'));
                    removeerror($('#id_login_id'));
					removeerror($('#id_transaction_key'));
                    flag3=true;
                }
                else{
                    flag3=false;
                    if($('#id_login_id').val()=="" ){adderror($('#id_login_id'));}
                    if($('#id_transaction_key').val()=="" ){adderror($('#id_transaction_key'));}
                }
            }else{
                removeerror($('#id_login_id'));
                removeerror($('#id_transaction_key'));
            }
			if($('#id_stripe').is(':checked')){
                if($('#id_stripe_public_key').val()!="" && $('#id_stripe_private_key').val()!=""){
                    removeerror($('#id_stripe'));
                    removeerror($('#id_stripe_public_key'));
                    removeerror($('#id_stripe_private_key'));
                    flag4=true;
                }
                else{
                    flag4=false;
                    if($('#id_stripe_public_key').val()=="" ){adderror($('#id_stripe_public_key'));}
                    if($('#id_stripe_private_key').val()=="" ){adderror($('#id_stripe_private_key'));}
                }
            }else{
                removeerror($('#id_stripe_public_key'));
                removeerror($('#id_stripe_private_key'));
            }
        }
        else{
            removeerror($('#id_paypal_payment'));
            removeerror($('#id_paypal_receiver_email'));
            removeerror($('#id_google_checkout'));
            removeerror($('#id_merchant_id'));
            removeerror($('#id_merchant_key'));
			removeerror($('#id_authorize'));
            removeerror($('#id_login_id'));
			removeerror($('#id_transaction_key'));
			removeerror($('#id_stripe'));
            removeerror($('#id_stripe_public_key'));
            removeerror($('#id_stripe_private_key'));
            flag1=true;
            flag2=true;
			flag3=true;
			flag4=true;
        }

        if(flag==true&&flag1==true&&flag2==true&&flag3==true&&flag4==true){return true;}
        else{return false;}
    }
    else{return false;}
}
function adderror(element){
    $(element).parent().parent().addClass('field-error');
    $(element).addClass('error');
}
function removeerror(element){
    $(element).parent().parent().removeClass('field-error');
    $(element).removeClass('error');
}
function save_payment(){
    valid=true;
    var flag = custom_validate();
    var dataString='';
    dataString+='&currency_symbol='+$('#id_currency_symbol').val();
    dataString+='&currency_code='+$('#id_currency_code').val();
    if($('#id_invoice_payment').is(':checked')){dataString+='&invoice_payment=on';}
	if($('#id_allow_subscription').is(':checked')){dataString+='&allow_subscription=on';}
    if($('#id_paypal_payment').is(':checked')){
        dataString+='&paypal_payment=on';
        dataString+='&paypal_receiver_email='+$('#id_paypal_receiver_email').val();
    }
    if($('#id_google_checkout').is(':checked')){
        dataString+='&google_checkout=on';
        dataString+='&merchant_id='+$('#id_merchant_id').val();
        dataString+='&merchant_key='+$('#id_merchant_key').val();
    }
	if($('#id_authorize').is(':checked')){
		dataString+='&authorize=on';
		dataString+='&login_id='+$('#id_login_id').val();
		dataString+='&transaction_key='+$('#id_transaction_key').val();
	}
	if($('#id_stripe').is(':checked')){
        dataString+='&stripe=on';
        dataString+='&stripe_public_key='+$('#id_stripe_public_key').val();
        dataString+='&stripe_private_key='+$('#id_stripe_private_key').val();
    }
    if(flag){
        $('#map-options').hide();
        $('#ajax_content_loading').show();
        $.ajax({
        type: "POST",
        url: "{% url 'admin_configuration_payment_update' %}",
        data: dataString,
        dataType:'JSON',
        success: function(data){
                valid=false;
                show_msg(data.msg,data.mtype);
                fun_fb_disable();
                fun_tw_disable();
				fun_au_disable();
				fun_sp_disable();
                $('#ajax_content_loading').hide();
                $('#map-options').fadeIn(2500).html(data.html);
            }
        });
    }
}
</script>
{% endblock %}
{% block content %}
<div id="admin_wrapper">
    <div id="admin-platform" class="group">
        <div class="header-bar">
            <div id="nav-roll">
                <ul>
                    <li id="config-index" class="first"><a href="{% url 'admin_configuration' %}" style="width:120px;z-index:9"><span class="icon"></span>{% trans 'Settings' %}</a></li>
                    <li><a href="{% url 'admin_configuration_payment' %}" style="z-index:8">{% trans 'Currency/Payment' %}</a></li>
                </ul>
            </div>
        </div>
        <div id="core-wraper" class="group">
            <div class="admin-main col_12 configuration">
                {% block leftnavigation %}
                    {% activetab 'topnav' 'config' %}
                    {% activetab 'leftnav' 'payment' %}
                    {{ block.super }}
                {% endblock %}
                <div class="left-nav-list-bg"></div>
                <div class="col_9 mr_0">
                    <div class="page-wrap">
                        <div class="page-head br_0">
                            <h2>{% trans 'Currency/Payment' %}</h2>
                            <p class="ltxt80">{% trans 'Setup online payment gateways for allowing payments to be made through the Internet.' %}</p>
                        </div>
                        {% include 'admin/configuration/include_payment.html' %}
                       </div>
                 </div>
               </div>
           {% include 'admin/configuration/payment-faq.html' %}
        </div>
    </div>
</div>
{% endblock %}