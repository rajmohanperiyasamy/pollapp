{% extends "user_base.html" %}
{% load i18n %}
{% load upload_tags %}
{% load tabs %}

{% block head %}
	
{% endblock %}

{% block navigation %}
	{% activetab "leftnav" "bookmark" %}
	{{ block.super }}
{% endblock %}

{% block content %}
	<div class="span10 sP9mX979 sP12mX767">
        <div class="row-fluid">
			<div class="main span9">
				<section class="sCn pD0 mH500">
					<div class="cLrFx pD20">
						<div class="pLlT">
							<h3 class="mR0 tRnCt">{% if bookmark %}Edit{% else %}Add{% endif %} Bookmark</h3>
						</div>
					</div>
					<hr class="mRb12 mRt0">
					<div class="pD20">
						<form action="." name="mform1" id="mform1" method="post" class="form-horizontal uSr-aCnT mRb0">{% csrf_token %}
							<div class="row-fluid">
                                <div class="alert alert-error hide" id="alert">
                                    <button onclick="$(this).parent('div#alert').addClass('hide');" class="close" type="button">Ã—</button>
                                    <span><strong>Oh snap!</strong> Can't fetch the URL. Change a few things up and try submitting again.</span>
                                </div>
                                <div class="control-group">
                                    <label class="control-label" >Source URL<em class="cLr-rEd">*</em></label>
                                    <div class="controls">
                                        <input id="id_source_url" name="source_url" type="text" class="iSp10" placeholder="http://www.example.com" value="{{bookmark.source_url}}">
                                    </div>
                                </div>
                                <div class="control-group">
                                    <div class="controls">
                                        <button type="button" class="btn btn-primary fS12 fW-bLd" id="proceed_button">Proceed</button>
                                    </div>
                                </div>
                            </div>
                            <div class="row-fluid hide" id="ajax_loading">
                                <div class="hT400 pDmR-10 mRb30 rLvE">
                                    <div class="tBl-bLk pDt0">
                                        <div class="tBl-cEl">
                                            <img src="{{STATIC_URL}}ui/images/global/loading.gif" align="...">
                                        </div>
                                    </div>
                                </div>
                            </div> 
                            <div id='proceed_with_details'>
                                <!-- Detailed form coming over here through AJAX -->
                                {% if bookmark %}{% include 'bookmarks/user/bookmark_form_details.html' %}{% endif %}
                            </div>
                        </form>
					</div>
				</section>
			</div> <!-- /.main -->
			<aside class="sD-bR span3">
				<div>
					<section class="tXt-cTr pD0 bNr-aD"> 
                       
                    </section>
				</div>
			</aside>
		</div>  <!-- /.row-fluid -->
	</div>  <!-- /.span10 -->
	<div id="update_caption" class="modal hide fade mW50" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 id="myModalLabel" class="mR50">Update Caption</h4>
        </div>
        <div class="modal-body">
			<div style="text-align: center; width: 100%;">
				<img src="{{STATIC_URL}}ui/images/global/loading.gif" align="...">
			</div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-light" type="submit" data-dismiss="modal">Cancel</button>
            <button class="btn btn-primary" type="submit" onclick="update_caption();">Done</button>
        </div>
    </div>
{% endblock %}

{% block footerarea %}
<script type="text/javascript">
	$(document).ready(function(){
        $('#id_source_url').bind('keydown',function(e){
            if(e.which == 13){
                e.preventDefault();
                proceed_fetching();
            }
        });
        $("#proceed_button").live('click',function(event){
            proceed_fetching();
        });
        {% if bookmark %}
            $(".image").on('click',function(event){
                $('.image.selected').removeClass('selected');
                $(this).addClass('selected');
                $('#id_image_url').val($(this).attr("data-imgurl"));
            });
        {% endif %}
        $("#mform1").validate({
            ignore:'',
            highlight: function(element, errorClass){
                $(element).parent('div').parent('div').addClass('error');
                $(element).parent('div').addClass('error');
                $(element).addClass('error');
            },
            unhighlight: function(element, errorClass){
                $(element).parent('div').parent('div').removeClass('error');
                $(element).parent('div').removeClass('error');
                $(element).removeClass('error');
            },
            errorPlacement: function(error, element){},
			invalidHandler: function(event, validator) { 
				var id = $(validator.errorList[0].element).parent('div');
				$('html,body').animate({ scrollTop: $(id).offset().top }, 'slow');
			},
            rules:{
                source_url: "required",
                category: "required",
                summary: "required",
            }
        });
	});
function proceed_fetching(){
    var csrf='';
    if($('input[name=csrfmiddlewaretoken]').val()!=undefined){csrf='&csrfmiddlewaretoken='+$('input[name=csrfmiddlewaretoken]').val()}
    $("#proceed_with_details").html('');
    $("#ajax_loading").show();
    var source_url = $("#id_source_url").val();
    if(source_url.match("^(http:\/\/|https:\/\/|ftp:\/\/){1}([0-9A-Za-z]+\.)"))
    {
        $.ajax({    
            type:       "post",
            url:        '{% url 'user_bookmark_fetch_images' %}',
            data:       "source_url="+$("#id_source_url").val()+csrf,
            dataType:   "html",
            success:    function( result ) {
                            $("#ajax_loading").hide();
                            $("#id_source_url").removeClass('error');
                            $("#id_source_url").parent().parent("div.control-group").removeClass('error');
                            $("#proceed_with_details").html(result);
                            //select menu
                            $('.bM-sLt').doThis(function(){
                                this.bUiSlCt();
                            });
                            $(".image").on('click',function(event){
                                $('.image.selected').removeClass('selected');
                                $(this).addClass('selected');
                                $('#id_image_url').val($(this).attr("data-imgurl"));
                            });
                        },
            error:      function( result ) {
                            $("#ajax_loading").hide();
                            $("#id_source_url").addClass('error');
                            $("#id_source_url").parent().parent("div.control-group").addClass('error');
                            $("#alert").show();
                        }
        });
    }
    else
    {   
        $("#ajax_loading").hide();
        $("#id_source_url").addClass('error');
        $("#id_source_url").parent().parent("div.control-group").addClass('error');
    }
}
</script>
{% endblock %}