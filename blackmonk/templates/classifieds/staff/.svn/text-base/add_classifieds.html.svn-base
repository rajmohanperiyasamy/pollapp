{% extends "staff_base.html" %}
{% load tabs %}
{% load upload_tags %}
{% load ds_utils %}
{% load i18n %}
{% block navigation %}
	{% activetab "selmodule" "classifieds" %}
	{{ block.super }}
{% endblock %}
{% block pagetitle %}{% trans 'Classifieds' %} {% endblock %}
{% block head %}
<!-- CALENDER -->
<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}themes/green/css/LE_MetaId99.css">
<!-- CALENDER -->

<!-- TAGS -->
	<link rel="stylesheet" type="text/css" href="{{STATIC_URL}}ui/css/jquery.tagit.css" />
<!-- TAGS -->
<link type="text/css" rel="stylesheet" href="{{STATIC_URL}}css/bm.jfp.ui.css">
{% endblock %}
{% block content %}
<div id="staff-platform" class="group">
	<div class="header-bar">
    	<a href="{% url 'staff_classified_home' %}"><h2><span class="go_back"></span>Classifieds</h2></a>
	</div>
    <div id="core-wraper" class="group">
    	<div class="staff-main">
        	<div class="page-wrap">
            	<div id="classifieds-add" class="group">
                	<div id="add-new-classifieds">
                	{% if form.errors or aform.errors %}
						<div class="messageerror" style="background:lightyellow;padding:10px;color:red">
							<strong>{% trans 'There is a problem with your submission' %}</strong>
		                    <ul style="list-style:square;margin-left:20px;">
								{% if form.errors %}
			               		{% for field in form %}
			               			{% if  field.errors%}
			               	        	<li>{% for error in field.errors %}{{ error }}{% endfor %}</li>
									{% endif %}
								{% endfor %}
								{% endif %}
			
								{% if aform.errors %}
			               		{% for field in aform %}
			               			{% if  field.errors%}
			               	        	<li>{% for error in field.errors %}{{ error }}{% endfor %}</li>
									{% endif %}
								{% endfor %}
								{% endif %}
							</ul>
						</div>
					{% endif %}
					<form class="modal-form" id="mform" name="mform" action="{% url 'add_classified' %}" method="post">{% csrf_token %}
                    	<div class="fields hform">
                        	<input type="hidden" value="S" id="id_action" name="action">
                            <ul class="sc-tabs">
                            	<li class="sc-tab {% if not classified %}sc-tab-selected{% endif %}{% if classified.action == 'S' %}sc-tab-selected{% else %}{% if classified %}sc-tab-unselected{% endif %}{% endif %} sc-first-tab inline-block" onclick="action_change('S')" id="S">{% trans "I'm offering..." %}</li>
                                <li class="sc-tab {% if classified.action == 'B' %}sc-tab-selected{% else %}sc-tab-unselected{% endif %} sc-last-tab inline-block" onclick="action_change('B')" id="B">{% trans 'I want...' %}</li>
                           	</ul>                                             
                            <div class="field-group">              
                            	<div class="field text-field fd-title">
                                	<div class="label"><label for="-button">{% trans 'Ad Title' %}<span class="required-field">*</span></label></div>
                                    <div class="value">{{form.title}}</div>
                               	</div>
                               	{% include 'common/coverphoto_form_staff.html' %} 
								<div class="field select-field relative-block" id="cat_holder">
                                	<div class="label"><label>{% trans 'Category' %}<span class="required-field">*</span></label></div>
                                    <div class="value">
                                    	<input type="hidden" id="classified" name="classified" value="{{classified.id}}">
                                        <input type="hidden" id="classified_category" name="classified_category" value="{% if classified %}{{classified.category.id}}{% else %}{% if category %}{{category.id}}{% endif%}{% endif%}">
                                        <div class="select-field-dupe" id="category_main" style="width:354px;cursor:pointer;">
                                        	<span class="select-status" id="category_main_text" >
                                            	{% if classified %}
													{{classified.category.parent}}&nbsp;&rarr;&nbsp;{{classified.category}}
												{% else %}
													{% if category %}
														{{category.parent}}&nbsp;&rarr;&nbsp;{{category}}
													{% else %}
														{% trans 'Select a Category' %}
													{% endif %}
												{% endif %}
											</span>
											<span class="select-icon"></span>
                                            	<div class="sub-modal" id="category_lightbox" style="width:360px;display:none; cursor:default;">
                                                	<div class="sub-modal-content">
                                                		<div class="field select-field">
                                                            <select name="parent_category" data-placeholder="{% trans 'Select a Category '%}" id="parent_category" style="width:330px;" class="select-menu">
                                                            	<option value=""></option>
																{% for pc in parent_category %}
																	<option value="{{pc.id}}">{{pc}}</option>
																{% endfor %}
                                                            </select>
                                                        </div>
                                                        <div class="field select-field" id="sub_cat_holder">
                                                        	<span class="load-item" id="cat_loading" style="padding-left:140px;display:none;"><img src="{{STATIC_URL}}ui/images/global/loading-s.gif" alt="...."></span>
                                                        		
                                                        </div>
                                                	</div>
                                                    <div class="sub-modal-footer group">
                                                    	<button style="cursor: pointer; float: right;" role="button"  id="category_close" class="btn-txt-blue btn-small" type="button"><span class="btn-txt" >{% trans 'OK' %}</span></button>
                                                    </div>        
                                                </div>
                                            </div>                                                  
											<span class="tip">{% trans 'Select main category and sub category here.' %}</span>
                                        </div>
										<div id="attributes_loading" style="display:none; position: absolute; right: 196px; top: 8px;">
											<img src="{{STATIC_URL}}ui/images/global/loading-s.gif" alt="....">
										</div>
                                    </div>                                                    
                                </div> 
 		                        <div class="field-group cr_wmr" id="attributes">
                                    {% include 'classifieds/ajax_update_classifieds_attribute.html' %}
                               </div>
                               <div class="field-group">
                                    <div class="fields-head"></div>
                                    <div class="field text-field">	
                                        <div class="label"><label for="-button">{% trans 'Description' %}<span class="required-field">*</span></label></div>	
                                        <div class="value">{{form.description}}</div>	
                                    </div>
                                    <div class="field text-field">	
                                        <div class="label">
                                        	<label for="-button">{% trans 'Tags' %}</label>
											<span class="tool-tip tttxt-w" original-title="Add multiple tags separated by comas ',' or use 'tab' key">?</span>
										</div>
                                        <div class="value has-fd-icon">
                                        	<input id='tags' type="hidden" class='tags error' name="tags" value="">
											<ul id="mytags" class="fl"></ul>
                                        	<!--img class="fd-icon" src="{{STATIC_URL}}ui/images/icons/b/66.png" alt=""-->
											<span class="tip">{% trans "Add multiple tags separated by comas ',' or use 'tab' key" %}</span>
                                        </div>
                                    </div>
                                
								
	                                <div class="fields-head"></div>  
									<div class="field text-field">	
									    <div class="label"><label for="">Address<span class="required-field">*</span></label></div>	
									    <div class="value">{{aform.address1}}</div>	
									</div>
									<div class="field text-field">	
									    <div class="label"></div>	
									    <div class="value">{{aform.address2}}</div>	
									</div>
									<div class="field text-field">	
									    <div class="label"><label for="">Zip/Postal Code<span class="required-field">*</span></label></div>	
									    <div class="value">{{aform.zip}}</div>	
									</div>
									<div class="field text-field">	
									    <div class="label"><label for="">City/Town<span class="required-field">*</span></label></div>	
									    <div class="value">{{aform.city}}</div>	
									</div>
									<div class="field text-field">	
									    <div class="value">
											<div id="map-canvas" style="height: 200px; position: relative; overflow: hidden; width: 576px; border-radius: 2px 2px 2px 2px; box-shadow: 1px 1px 5px rgba(0, 0, 0, 0.2); border: 1px solid rgb(204, 204, 204);"></div>
											<input type="hidden" name="lat_lng" id="lat_lng" value=""/>
											<input type="hidden" name="zoom" id="zoom" value=""/>
										</div>	
									</div>
									<div class="field text-field">
									    <div class="label"></div>
									    <div class="value">
									        <div class="group">
									            <span class="inline-block pdr6 fs">
									                <label for="">Main Phone</label>{{aform.telephone1}}
									            </span>
									            <span class="inline-block fs">
									                <label for="">Mobile</label>{{aform.mobile}}
									            </span>
									        </div>
									    </div>
									</div>
									<div class="field text-field">	
									    <div class="label"><label for="">Fax</label></div>	
									    <div class="value">
									        {{aform.fax}}
										</div>	
									</div>
									<div class="field text-field">	
									    <div class="label"><label for="">Email address<span class="required-field">*</span></label></div>	
									    <div class="value">{{aform.email}}</div>	
									</div>
									<div class="field text-field">	
									    <div class="label"><label for="">Website</label></div>	
									    <div class="value">{{aform.website}}</div>	
									</div>
								</div>
								<div class="field-group">
                               		<div class="fields-head"></div>
									<div class="field text-field">
										<div class="label"><label for=""></label></div>	
										<div class="value">
											<div id="fileupload" >
										 		<div class="fileupload-content" style="padding-left:20px;">
										    		<ul class="files bm-uploader-list"></ul>
												</div><div class="clear"></div>
								    			<div id="bm-dropzone_area" class="dropzone">{% trans 'Drop the files here' %}</div>
								            	{% csrf_token %}<div class="clear"></div>
								            	<div class="upload-button-wrapper"  style="padding-left:20px;">
								                	<a class="upload-button">{% trans 'Add Photos' %}</a>
								                    <div class="fileinput-button">
								                    	<input type="file" name="photo" id="id_photo" multiple=""  accept="image/*" tabindex="-1">
													</div>
								                </div>
											</div>
										</div>
									</div>
								</div> 
								{% if classified_price_objects %}                                              
								<div class="field-group" id="listing_classifieds" style="{% if not classified and not category %}display:none;{% endif %}">
                                    <div class="fields-head"></div>
                                    <div class="field text-field">	
                                        <div class="label"><label for="">{% trans 'Listing Type' %}</label></div>	
                                        <div class="value">
                                        	<div class="fd-cols mrb0 pd50 group">
                                                {% for classified_price in classified_price_objects %}
													<span class="pdr6"><label for="typeFeatured" id="l:typeFeatured"><input type="radio" value="{{classified_price.id}}" onclick="payment_option({{classified_price.id}})" name="listingtype" {% if forloop.first %}{% if not classified %}CHECKED{% endif %}{% endif %}{% ifequal classified.payment.id classified_price.id %}CHECKED{% endifequal%} id="{{classified_price.id}}">{{classified_price.level_label}}</label></span>
												{% endfor %} 
											</div> 
											<div class="fd-cols mrb0 pd50 group" style="float:left !important;">
												<input type="hidden" id="current_date" value="{% now "M d Y" %}">
												{% trans 'From' %} {{form.listing_start_date}} {% trans 'to' %} {{form.listing_end_date}}
											</div>       
											{% for classified_price in classified_price_objects %}
												<div id="id_{{classified_price.id}}" class="payment_div" style="float:left;width:200px;padding:15px 0 0 10px;{% if classified %}{% ifnotequal classified.payment.id classified_price.id %}display:none;{% endifnotequal%}{% endif %}{% if not classified %}{% if not forloop.first %}display:none{% endif %}{% endif %}">
													<h4 class="price_lrg">
													{% if classified_price.level == 'level1' %}
															{% if classified_price.level != 'level0' %}
																<span class="rs mdm">{{globalsettings.currency}}</span>
																{% if classified.category.parent.sp_price %}
																	<input type="text" class="cat_price cat_listing_price" style="width:160px !important;" name="price_{{classified_price.id}}" id="price_{{classified_price.id}}" class="tttxt" value="{% if classified.payment.id == classified_price.id  %}{{classified.price|floatformat}}{% else %}{{classified.category.parent.sp_price|floatformat}}{% endif %}">
																{% else %}
																	<input type="text" class="cat_price cat_listing_price" style="width:160px !important;" name="price_{{classified_price.id}}" id="price_{{classified_price.id}}" class="tttxt">
																{% endif %}
																<span class="price_sub">
																	<input type="hidden" id="period_{{classified_price.id}}" value="{{classified_price.contract_period}}">
																</span>
															{% else %}
															<input type="hidden" id="period_{{classified_price.id}}" value="1">
															{% endif %}
													{% else %}
							                        		{% if classified_price.level != 'level0' %}
																<span class="rs mdm">{{globalsettings.currency}}</span>
																<input type="text" name="price_{{classified_price.id}}" style="width:160px !important;" id="price_{{classified_price.id}}" class="tttxt cat_listing_price" value="{% if classified.payment.id == classified_price.id  %}{{classified.price|floatformat}}{% else %}{{classified_price.price|floatformat}}{% endif %}">
																<span class="price_sub">
																	<input type="hidden" id="period_{{classified_price.id}}" value="{{classified_price.contract_period}}"> 
																</span>
															{% else%}
																<input type="hidden" id="period_{{classified_price.id}}" value="1">
															{% endif %}
							                    	{% endif %}
													</h4>
												</div>
											{% endfor %} <div class="clear"></div>
											<span class="tip" style="display:inline-block;">{% trans ' Choose how would you like to promote your classified ad in the website.' %}</span>
										</div>	
                                    </div>
                                </div> 
								{% endif %}
								</div> 
                                <div class="form-submit right group">
                                   <button class="cform-button" onclick="window.location.replace('{% url 'staff_classified_home' %}')" type="button" roll="button"><span class="cform-button-text">{% trans 'Cancel' %}</span></button>
                                   <button role="button" class="cform-button prime id_class_submit" type="submit" id="savebutton"><span class="cform-button-text">{% trans 'SAVE' %}</span></button>
                                </div>                                                
                            </form>
                        </div>																	                                        
                    </div> <!-- end table -->                                    
                </div><!-- end page wrap -->
            </div>  <!-- end main-col -->  
			<div id="aside" class="side-bar">
			{% include 'classifieds/staff/add_update_faq.html' %}
			</div>        
	</div>                            
</div>
{% endblock %}			
{% block footer_include %}
<!-- TAGS -->
	<script type="text/javascript" src="{{STATIC_URL}}ui/js/jquery.ui.autocomplete.js"></script>
	<script type="text/javascript" src="{{STATIC_URL}}ui/js/tag-it.js"></script>
<!-- TAGS -->
<script type="text/javascript" src="{{ STATIC_URL }}js/jquery/jquery.validate.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/jquery/jquery.ui.datepicker.js"></script>
{% upload_js %}
<script type="text/javascript" src="{{STATIC_URL}}js/jquery/bm.jfp.js"></script>
<script type="text/javascript" src="{{STATIC_URL}}js/jquery/bm.fup.appln.js"></script>
<script type="text/javascript" src="{{STATIC_URL}}js/cropper.js"></script>
<script src="{{ STATIC_URL }}js/ckeditor4/ckeditor.js" type="text/javascript"></script>
<script src="http://maps.googleapis.com/maps/api/js?v=3&sensor=false{% if globalsettings.google_map_key %}&key={{ globalsettings.google_map_key }}{% endif %}" type="text/javascript"></script>
<script type="text/javascript" src="{{STATIC_URL}}js/general/google_map.js"></script>
<script type="text/javascript">
var edt;
function updateTextArea(edt){
    CKEDITOR.tools.setTimeout( function(){ 
        $('#id_description').val(edt.getData());
        $("#id_description").trigger('keyup');
    }, 0);  
}
	try{
		var instance = CKEDITOR.instances['id_description'];
		CKEDITOR.remove(instance);
	}
	catch(e){}
	/*
	CKEDITOR.on( 'instanceCreated', function( e ){
		   e.editor.addCss('body { font-size:12px; font-family:Arial, "Times New Roman", Verdana;}');
	});
	*/
	var edt=CKEDITOR.replace( 'id_description',
	{					
		customConfig : '{{ STATIC_URL }}js/ckeditor/custome_config.js',
		toolbar : 'Basic' 
	});

//]]>
edt.on('key', function(event) {updateTextArea(edt);});
	$('#id_description').keyup(function(){$('#id_description').valid();})
</script>
<script type="text/javascript">
function validate(){
	var payment_id=$('input[name=listingtype]:checked').val();
	var flag=$("#mform").validate().form();
	var flag1=/^[0-9]+$/.test($('#price_'+payment_id).val())	
	if(flag&&flag1){return true;}
	else{return false;}
}
$(document).ready(function(){
	$('#id_email').val("{{request.user.useremail}}");
	$('.cat_listing_price').keyup(function(){
		var flag=/^[0-9]+$/.test($(this).val());
		if(flag){remove_error_class($(this));}
		else{add_error_class($(this));}
	});
	$.validator.addMethod("desc_required", function(value, element) {  
    	$('#id_description').val(edt.getData());
		if($('#id_description').val()!=''){return true;}
		else{return false;}
	},"Please enter a description.");
	$("#mform").validate({
		ignore:'',
		highlight: function(element, errorClass){add_error_class(element)},
		unhighlight: function(element, errorClass){remove_error_class(element)},
		errorPlacement: function(error, element){},
		invalidHandler: function(event, validator) { 
			var id = $(validator.errorList[0].element).parent('div').parent('div');
			$('html,body').animate({ scrollTop: $(id).offset().top - 60 }, 'slow');
		},
	   	rules:{
	    	title: "required",
			description:"desc_required",
			parent_category:"required",
			category:"required",
			classified_category:"required",
			classified_price:'number',
			address1:"required",
			city:{required:true,maxlength:70},
			zip:"required",
			email:{required:true,email:true},
			website:{required:false,url:true},
	   	},
		submitHandler:function(){
			get_lat_lang();
			$('.id_class_submit').attr('disabled','disabled');
			$('.id_class_submit').css('opacity',0.5);
			form.submit();
		}
	});

	$( ".id_class_submit" ).click(function(event){
		setTimeout(function(){
			$('.id_class_submit').removeAttr('disabled');
			$('.id_class_submit').css('opacity',1);
		},3000);
	});
	
	$('#id_website').focusin(function(){
		if($('#id_website').val()==""){
				$('#id_website').val('http://www.');
		}
		  
	});
	$('#id_website').focusout(function(){
	if($('#id_website').val()=='http://www.'){
				$('#id_website').val('');
			$(this).parent('div').parent('div').removeClass('field-error');$('#id_website').removeClass("error");	
			}
	});
	$('#id_city').live("keyup",function(){getPin(getaddress(),$('#id_zip').val());});


	if($("#id_listing_start_date").length){
		$("#id_listing_start_date").datepicker({ dateFormat: "yy-mm-dd",minDate: new Date(),
            onSelect: function(){
                enddate = $(this).val();
                splittedval = enddate.split('-');
                var date = new Date(splittedval[0], splittedval[1]-1, splittedval[2]);
                //date.setDate(date.getDate() + 1);
                $("#id_listing_end_date").datepicker( "option", "minDate", date );
            }
        });
	}
	if($("#id_listing_end_date").length){
		$("#id_listing_end_date").datepicker({ dateFormat: "yy-mm-dd",minDate: new Date() });
	}
	$('body').click(function(){
		if ($('#category_lightbox').css("display") == "block")
    		$('#category_lightbox').hide();
	});
	$('#category_main').click(function(e){
		e.stopPropagation();
		if ($('#category_lightbox').css("display") == "none")
    		$('#category_lightbox').show();
		else
   			 $('#category_lightbox').hide();
	});
	$('#category_lightbox').click(function(e){e.stopPropagation();});
	$('#category_close').click(function(e){
		e.stopPropagation();
		$('#category_lightbox').hide();
		if($('#category').val()!='' && $('#parent_category').val()!=''){
			$('#category_main_text').html($('#parent_category :selected').text()+'&nbsp;&rarr;&nbsp;'+$('#category :selected').text())
			load_attributes($('#category').val());
		}else{
			$('#category_main_text').html(gettext('Select a Category'))
			$('#attributes').hide();
			$('#listing_classifieds').hide();
			$('#category').val('');
			$('#classified_category').val('');
		}
		//on_change_validate();
	});
	
	$('#parent_category').live('change',function(){
		if($('#parent_category').val()!=''){
			$('#category_chzn').hide();
			$('#cat_loading').show();
			$.ajax({
			type: "GET",
			url: "{% url 'ajax_get_sub_category' %}",
			data: 'id='+$('#parent_category').val(),
			dataType:'JSON',
			success: function(data){
					$('#cat_loading').hide();
					$('#category_chzn').show();
					$('#sub_cat_holder').html(data.html);
					$('#category').chosen({disable_search_threshold:10}); 
				}
			});
		}else{
			$('#category_chzn').hide();
		}
	});
	
	file_upload('{% url 'classifieds_ajax_upload_photos' %}?id={{classified.id}}',5);
	{% with form.instance|content_type as ctype %}
	cover_photo_upload("{% url 'common_upload_cover_photo' %}?ctype={{ctype.pk}}&cobj={{form.instance.id}}", 100/70);
	{% endwith %}
	{% if not classified %}
	{% if new_pic %}
		get_images('{% url 'classifieds_ajax_get_default_photos' %}?ids={% for np in new_pic %}{{np}}{% if not forloop.last %},{% endif %}{% endfor %}')
	{% endif %}
	{% endif %}
	
	$("#mytags").tagit({
       singleField: true,
       singleFieldNode: $('#tags'),
	   allowSpaces:true,
       tagSource: function( request, response ) {
         $.ajax({
		       url: '{% url 'auto_suggest_tag_classifieds' %}',
		       data: { term:request.term },
		       dataType: "json",
		       success: function( data ) {
		       response( $.map( data, function( item ) {
		       return {
			   	label: item.label, value: item.value 
				}}
				));
       		}
       });
      }});
	  {% if classifieds_tags %}
		  {% for tag in classifieds_tags %}
		  	$("#mytags").tagit('createTag','{{tag}}');
		  {% endfor%}
	  {% endif %}
	  {% if classified %}
	  	$('#parent_category [value={{classified.category.parent.id}}]').attr('selected','selected');
		$('#category [value={{classified.category.id}}]').attr('selected','selected');
	  {% else %}
		 {% if category %}
		  	$('#parent_category [value={{category.parent.id}}]').attr('selected','selected');
			$('#category [value={{category.id}}]').attr('selected','selected');
		  {% endif %}		
	  {% endif %}
	  
});
function load_attributes(id){
	$('#classified_category').val(id);
	$('#attributes_loading').show();
	$('#attributes').hide();
	var dataString="id="+id;
	if($('#classified').val()!=''){dataString+='&cid='+$('#classified').val()}
	$.ajax({
		type: "GET",
		url: "{% url 'ajax_get_category_attribute' %}",
		data: dataString,
		dataType:'JSON',
		success: function(data){
				$('#parent_category').removeClass('error');
				$('#category').removeClass('error');
				$('.select-field-dupe').parent().parent().removeClass('field-error');
				$('#attributes_loading').hide();
				$('#attributes').html(data.html);
				$('#attributes').show();
				$('.append_attr').chosen({disable_search_threshold:10}); 
				$('.cat_price').val(data.cat_price);
				$('#listing_classifieds').show();
			}
		});
}
function action_change(id){
	$('.sc-tab').removeClass('sc-tab-selected').addClass('sc-tab-unselected');
	$('#'+id).removeClass('sc-tab-unselected');
	$('#'+id).addClass('sc-tab-selected');
	$('#id_action').val(id);
}
{% if action %}
	action_change('{{action}}')
{% endif %}
function payment_option(id){
	$('.payment_div').hide();
	var now = new Date($('#current_date').val());
	now.setMonth((parseInt(now.getMonth())+parseInt($('#period_'+id).val())));
	$('#id_listing_end_date').val($.datepicker.formatDate('yy-mm-dd',now));
	$('#id_'+id).show();
}
{% if address %}
		load_for_add('map-canvas',{{ address.lat }}, {{ address.lon }}, {{ address.zoom }},'{{ address.city }}','{{ globalsettings.city }} - {{address.zip}}');
	{% else %}
		load_for_add('map-canvas',{{ globalsettings.google_map_lat }}, {{ globalsettings.google_map_lon }}, {{ globalsettings.google_map_zoom }},'{{ globalsettings.city }}','{{ globalsettings.city }}');
	{% endif %}
	$( "#id_zip" ).autocomplete({
			source: '{% url 'auto_suggest_pin' %}',
		   	select: function(event, ui) {
     			$("#id_zip").val(ui.item.id);
     	 	}
	});
	function get_lat_lang(){
		var lat_lng = marker.getPosition();
		var zoom = map.getZoom();
		$('#lat_lng').val(lat_lng);
		$('#zoom').val(zoom);
	}
	function getaddress(){return $('#id_address1').val()+" "+$('#id_address2').val()+" "+$('#id_city').val();}
</script>
{% endblock %}	
				