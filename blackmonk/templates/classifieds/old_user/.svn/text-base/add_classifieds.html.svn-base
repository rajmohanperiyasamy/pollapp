{% extends "user_base.html" %}
{% load tabs %}
{% load upload_tags %}
{% load i18n %}
{% block navigation %}
	{% activetab "selmodule" "classifieds" %}
	{{ block.super }}
{% endblock %}
{% block pagetitle %}{% trans 'Classifieds' %} {% endblock %}
{% block head %}
<!-- CALENDER -->
<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}themes/green/css/LE_MetaId99.css">
<!-- CALENDER -->

<!-- TAGS -->
	<link rel="stylesheet" type="text/css" href="{{STATIC_URL}}ui/css/jquery.tagit.css" />
<!-- TAGS -->
<link type="text/css" rel="stylesheet" href="{{STATIC_URL}}css/bm.jfp.ui.css">
{% endblock %}
{% block content %}
<div id="userHub-platform" class="group">
	<div class="header-bar">
    	<a href="{% url 'user_classified_home' %}"><h2><span class="go_back"></span>Classifieds</h2></a>
	</div>
    <div id="core-wraper" class="group">
    	<div class="userHub-main">
        	<div class="page-wrap">
            	<div id="classifieds-add" class="group">
                	<div id="add-new-classifieds">
                	{% if form.errors %}
						<div class="messageerror" style="background:lightyellow;padding:10px;color:red">
							<strong>{% trans 'There is a problem with your submission' %}</strong>
		                    <ul style="list-style:square;margin-left:20px;">
			               		{% for field in form %}
			               			{% if  field.errors%}
			               	        	<li>{% for error in field.errors %}{{ error }}{% endfor %}</li>
									{% endif %}
								{% endfor %}
							</ul>
						</div>
					{% endif %}
					<form class="modal-form" id="mform" name="mform" action="{% url 'user_add_classified' %}" method="post">{% csrf_token %}
                    	<div class="fields hform">
                        	<input type="hidden" value="S" id="id_action" name="action">
                            <ul class="sc-tabs">
                            	<li class="sc-tab {% if not classified %}sc-tab-selected{% endif %}{% if classified.action == 'S' %}sc-tab-selected{% else %}{% if classified %}sc-tab-unselected{% endif %}{% endif %} sc-first-tab inline-block" onclick="action_change('S')" id="S">{% trans "I'm offering..." %}</li>
                                <li class="sc-tab {% if classified.action == 'B' %}sc-tab-selected{% else %}sc-tab-unselected{% endif %} sc-last-tab inline-block" onclick="action_change('B')" id="B">{% trans 'I want...' %}</li>
                           	</ul>                                             
                            <div class="field-group">              
                            	<div class="field text-field fd-title">
                                	<div class="label"><label for="-button">{% trans 'Ad Title' %}<span class="required-field">*</span></label></div>
                                    <div class="value">{{form.title}}</div>
                               	</div> 
								<div class="field select-field relative-block" id="cat_holder">
                                	<div class="label"><label>{% trans 'Category' %}<span class="required-field">*</span></label></div>
                                    <div class="value">
                                    	<input type="hidden" id="classified" name="classified" value="{{classified.id}}">
                                        <input type="hidden" id="classified_category" name="classified_category" value="{% if classified %}{{classified.category.id}}{% else %}{% if category %}{{category.id}}{% endif%}{% endif%}">
                                        <div class="select-field-dupe" id="category_main" style="width:350px;cursor:pointer;">
                                        	<span class="select-status" id="category_main_text" >
                                            	{% if classified %}
													{{classified.category.parent}}&nbsp;&rarr;&nbsp;{{classified.category}}
												{% else %}
													{% if category %}
														{{category.parent}}&nbsp;&rarr;&nbsp;{{category}}
													{% else %}
														{% trans 'Select a Category' %}
													{% endif %}
												{% endif %}
											</span>
											<span class="select-icon"></span>
                                            	<div class="sub-modal" id="category_lightbox" style="width:356px;display:none; cursor:default;">
                                                	<div class="sub-modal-content">
                                                		<div class="field select-field">
                                                            <select name="parent_category" data-placeholder="{% trans 'Select a Category '%}" id="parent_category" style="width:330px;" class="select-menu">
                                                            	<option value=""></option>
																{% for pc in parent_category %}
																	<option value="{{pc.id}}">{{pc}}</option>
																{% endfor %}
                                                            </select>
                                                        </div>
                                                        <div class="field select-field" id="sub_cat_holder">
                                                        	<span class="load-item" id="cat_loading" style="padding-left:140px;display:none;"><img src="{{STATIC_URL}}ui/images/global/loading-s.gif" alt="...."></span>
                                                        </div>
                                                	</div>
                                                    <div class="sub-modal-footer group">
                                                    	<button style="cursor: pointer; float: right;" role="button"  id="category_close" class="btn-txt-blue btn-small" type="button"><span class="btn-txt" >{% trans 'OK' %}</span></button>
                                                    </div>        
                                                </div>
                                            </div> 
											<span class="tip">{% trans 'Select main category and sub category here.' %}</span>                                                 
                                        </div>
										<div id="attributes_loading" style="display:none; position: absolute; right: 196px; top: 8px;">
											<img src="{{STATIC_URL}}ui/images/global/loading-s.gif" alt="....">
										</div>
                                    </div>                                                    
                                </div> 						
 		                        <div class="field-group cr_wmr" id="attributes">
                                    {% include 'classifieds/ajax_update_classifieds_attribute.html' %}
                               </div>
                               <div class="field-group">
                                    <div class="fields-head"></div>
                                    <div class="field text-field">	
                                        <div class="label"><label for="-button">{% trans 'Description' %}<span class="required-field">*</span></label></div>	
                                        <div class="value">{{form.description}}</div>	
                                    </div>
                                    <div class="field text-field">	
                                        <div class="label">
                                        	<label for="-button">{% trans 'Tags' %}</label>
										</div>
                                        <div class="value has-fd-icon">
                                        	<input id='tags' type="hidden" class='tags' name="tags"  value="">
											<ul id="mytags" class="fl"></ul>
                                        	<!--img class="fd-icon" src="{{STATIC_URL}}ui/images/icons/b/66.png" alt=""-->
											<span class="tip">{% trans "Add multiple tags separated by comas ',' or use 'tab' key" %}</span>
                                        </div>
                                    </div>
                                </div>
								<div class="field-group">
                                    <div class="fields-head"></div>
                                    <div class="field text-field">
                                        <div class="label"><label for="-button">{% trans 'Email' %}<span class="required-field">*</span></label></div>
                                        <div class="value">{{form.email}}</div>
                                    </div> 
                                    <div class="field text-field">
                                        <div class="label"><label for="-button">{% trans 'Phone' %}<span class="required-field">*</span></label></div>
                                        <div class="value">{{form.phone_no}}</div>
                                    </div>                                                     
                                </div>  
								<div class="field-group">
                               		<div class="fields-head"></div>
									<div class="value">
										<div id="fileupload" >
									 		<div class="fileupload-content" style="padding-left:20px;">
									    		<ul class="files bm-uploader-list"></ul>
											</div><div class="clear"></div>
							    			<!--div id="bm-dropzone_area" class="dropzone">{% trans 'Drop the files here' %}</div-->
							            	{% csrf_token %}<div class="clear"></div>
							            	<div class="upload-button-wrapper"  style="padding-left:20px;">
							                	<a class="upload-button">{% trans 'Add Images' %}</a>
							                    <div class="fileinput-button">
							                    	<input type="file" name="photo" id="id_photo" multiple=""  accept="image/*" tabindex="-1">
												</div>
							                </div>
										</div>
									</div>
								</div>
								</div> 
                                <div class="form-submit right group">
                                   <button class="cform-button" onclick="window.location.replace('{% url 'user_classified_home' %}')" type="button" roll="button"><span class="cform-button-text">{% trans 'Cancel' %}</span></button>
                                   <button role="button" class="cform-button prime" value="draft" name="draft" type="submit"><span class="cform-button-text">{% trans 'SAVE AS DRAFT' %}</span></button>
								   <button role="button" class="cform-button prime" type="submit"><span class="cform-button-text">{% trans 'SAVE & NEXT' %}</span></button>
                                </div>                                                
                            </form>
                        </div>																	                                        
                    </div> <!-- end table -->                                    
                </div><!-- end page wrap -->
            </div>  <!-- end main-col -->  
			<div id="aside" class="side-bar">
			{% include 'classifieds/staff/add_update_faq.html' %}
			</div>        
	</div>                            
</div>
{% endblock %}			
{% block footer_include %}
<!-- TAGS -->
	<script type="text/javascript" src="{{STATIC_URL}}ui/js/jquery.ui.autocomplete.js"></script>
	<script type="text/javascript" src="{{STATIC_URL}}ui/js/tag-it.js"></script>
<!-- TAGS -->
<script type="text/javascript" src="{{ STATIC_URL }}js/jquery/jquery.validate.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/jquery/jquery.ui.datepicker.js"></script>
{% upload_js %}
<script type="text/javascript" src="{{STATIC_URL}}js/jquery/bm.jfp.js"></script>
<script type="text/javascript" src="{{STATIC_URL}}js/jquery/bm.fup.appln.js"></script>
<script src="{{ STATIC_URL }}js/ckeditor/ckeditor.js" type="text/javascript"></script>
<script type="text/javascript">
	try{
		var instance = CKEDITOR.instances['id_description'];
		CKEDITOR.remove(instance);
	}
	catch(e){}
	CKEDITOR.on( 'instanceCreated', function( e ){
		   e.editor.addCss('body { font-size:12px; font-family:Arial, "Times New Roman", Verdana;}');
   });
		var edt=CKEDITOR.replace( 'id_description',
		{					
		    
			customConfig : '{{ STATIC_URL }}js/ckeditor/custome_config.js',
			toolbar : 'Basic'
		});

//]]>
</script>
<script type="text/javascript">
$(document).ready(function(){
	$.validator.addMethod("desc_required", function(value, element) {  
    	$('#id_description').val(edt.getData());
		if($('#id_description').val()!=''){return true;}
		else{return false;}
	},"Please enter a description.");
	$("#mform").validate({
		ignore:'',
		highlight: function(element, errorClass){add_error_class(element)},
		unhighlight: function(element, errorClass){remove_error_class(element)},
		errorPlacement: function(error, element){},
	   	rules:{
	    	title: "required",
			description: "desc_required",
			phone_no:"required",
			parent_category:"required",
			category:"required",
			classified_category:"required",
			classified_price:'number',
			email:{
				required:true,
				email:true
			}				
	   	}
	});
	
	if($("#id_listing_end_date").length){
		$("#id_listing_end_date").datepicker({ dateFormat: "yy-mm-dd",minDate: new Date() });
	}
	if($("#id_listing_start_date").length){
		$("#id_listing_start_date").datepicker({ dateFormat: "yy-mm-dd",minDate: new Date()});
	}
	$('body').click(function(){
		if ($('#category_lightbox').css("display") == "block")
    		$('#category_lightbox').hide();
	});
	$('#category_main').click(function(e){
		e.stopPropagation();
		if ($('#category_lightbox').css("display") == "none")
    		$('#category_lightbox').show();
		else
   			 $('#category_lightbox').hide();
	});
	$('#category_lightbox').click(function(e){e.stopPropagation();});
	$('#category_close').click(function(e){
		e.stopPropagation();
		$('#category_lightbox').hide();
		if($('#category').val()!='' && $('#parent_category').val()!=''){
			$('#category_main_text').html($('#parent_category :selected').text()+'&nbsp;&rarr;&nbsp;'+$('#category :selected').text())
			load_attributes($('#category').val());
		}else{
			$('#category_main_text').html(gettext('Select a Category'))
			$('#attributes').hide();
			$('#category').val('');
			$('#classified_category').val('');
		}
		on_change_validate();
	});
	
	$('#parent_category').live('change',function(){
		if($('#parent_category').val()!=''){
			$('#category_chzn').hide();
			$('#cat_loading').show();
			$.ajax({
			type: "GET",
			url: "{% url 'ajax_get_sub_category' %}",
			data: 'id='+$('#parent_category').val(),
			dataType:'JSON',
			success: function(data){
					$('#cat_loading').hide();
					$('#category_chzn').show();
					$('#sub_cat_holder').html(data.html);
					$('#category').chosen({disable_search_threshold:10}); 
				}
			});
		}else{
			$('#category_chzn').hide();
		}
	});
	
	file_upload("{% url 'classifieds_ajax_upload_photos' %}?id={{classified.id}}",5);
	{% if not classified %}
	{% if new_pic %}
		get_images('{% url 'classifieds_ajax_get_default_photos' %}?ids={% for np in new_pic %}{{np}}{% if not forloop.last %},{% endif %}{% endfor %}')
	{% endif %}
	{% endif %}

	$("#mytags").tagit({
       singleField: true,
       singleFieldNode: $('#tags'),
	   allowSpaces:true,
       tagSource: function( request, response ) {
         $.ajax({
		       url: '{% url 'auto_suggest_tag_classifieds' %}',
		       data: { term:request.term },
		       dataType: "json",
		       success: function( data ) {
		       response( $.map( data, function( item ) {
		       return {
			   	label: item.label, value: item.value 
				}}
				));
       		}
       });
      }});
	  {% if classifieds_tags %}
		  {% for tag in classifieds_tags %}
		  	$("#mytags").tagit('createTag','{{tag}}');
		  {% endfor%}
	  {% endif %}

	  {% if classified %}
	  	$('#parent_category [value={{classified.category.parent.id}}]').attr('selected','selected');
		$('#category [value={{classified.category.id}}]').attr('selected','selected');
	  {% else %}
		 {% if category %}
		  	$('#parent_category [value={{category.parent.id}}]').attr('selected','selected');
			$('#category [value={{category.id}}]').attr('selected','selected');
		  {% endif %}		
	  {% endif %}
	  
});
function load_attributes(id){
	$('#classified_category').val(id);
	$('#attributes_loading').show();
	$('#attributes').hide();
	var dataString="id="+id;
	if($('#classified').val()!=''){dataString+='&cid='+$('#classified').val()}
	$.ajax({
		type: "GET",
		url: "{% url 'ajax_get_category_attribute' %}",
		data: dataString,
		dataType:'JSON',
		success: function(data){
				$('#parent_category').removeClass('error');
				$('#category').removeClass('error');
				$('.select-field-dupe').parent().parent().removeClass('field-error');
				$('#attributes_loading').hide();
				$('#attributes').html(data.html);
				$('#attributes').show();
				$('.append_attr').chosen({disable_search_threshold:10}); 
			}
		});
}
function action_change(id){
	$('.sc-tab').removeClass('sc-tab-selected').addClass('sc-tab-unselected');
	$('#'+id).removeClass('sc-tab-unselected');
	$('#'+id).addClass('sc-tab-selected');
	$('#id_action').val(id);
}
{% if action %}
	action_change('{{action}}')
{% endif %}
</script>
{% endblock %}	
				