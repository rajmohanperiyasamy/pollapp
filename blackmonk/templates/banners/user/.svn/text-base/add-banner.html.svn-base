{% extends "user_base.html" %}
{% load i18n %}
{% load upload_tags %}
{% load tabs %}

{% block head %}
	<link type="text/css" rel="stylesheet" href="{{STATIC_URL}}css/bm.jfp.ui.css">
	<script type="text/javascript" src="{{ STATIC_URL }}js/ckeditor/ckeditor.js"></script>
<style type="text/css">
	.bm_faded {
	opacity: 0.5;
	pointer-events: none;
	}
</style>
{% endblock %}

{% block navigation %}
	{% activetab "leftnav" "banners" %}
	{{ block.super }}
{% endblock %}

{% block content %}
	<div class="span10 sP9mX979 sP12mX767">
        <div class="row-fluid">
			<div class="main span9">
				<section class="sCn pD0">
					<div class="cLrFx pD20">
						<div class="pLlT">
							<h3 class="mR0 tRnCt">{% if not banner_obj %}Submit{% else %}Update{% endif %} Banner</h3>
						</div>
					</div>
					<hr class="mRb12 mRt0">
					<div class="pD20">
						<form id="mform" name="mform" action="{% url 'user_banners_add_banner' %}{% if banner_obj %}?bid={{banner_obj.id}}{% endif %}" method="post"  enctype="multipart/form-data" class="form-horizontal uSr-aCnT mRb0">{% csrf_token %}
							{% if form.errors %}
                            <div class="messageerror" >
                                <span style="font-size:1.2em;font-weight:250;"><strong>{% trans "There is a problem with your submission" %}</strong></span>
                                {% if form.errors %}
                                <ul>{% for field in form %}
                                     {% if field.errors%}<li>{%for error in field.errors%}{{error}}{%endfor%}</li>{% endif %}
                                 {% endfor %}</ul>
		                                {% endif %}
		                            </div>
		                        {% endif %}
                            <div class="control-group">
                                <label class="control-label" >Caption<em class="cLr-rEd">*</em></label>
                                <div class="controls">
                                    {{ form.caption }}
									<input style="" type="hidden" onkeyup="fillslug_add(this.value);" name="slug" value="{% if slug %}{{ slug }}{% endif %}" id="id_slug" class="default-url slug_input">
									<input type="hidden" value="{% if article.article_type %}{{article.article_type}}{% else %}{{article_type}}{% endif %}" name="article_type" id="id_article_type">
                                </div>
                            </div>
							{% if banner_obj %}
							<div class="control-group">
                                <label class="control-label" >Modules<em class="cLr-rEd">*</em></label>
                                <div class="controls">
                                    <select class="iSp8 bM-sLt" data-size="8" id="id_section" name="section" onchange="load_categories()" title="Select a module">
										<option value=""></option>
										{% for mod in banner_zones_obj.sections.all %}
											<option value={{mod.id}} {% if banner_obj.section_id == mod.id  %}selected="selected"{% endif %}>{{mod.name}}</option>
										{% endfor %}
									</select>
                                </div>
                            </div>
							{% else %}
                            <div class="control-group">
                                <label class="control-label" >Modules<em class="cLr-rEd">*</em></label>
                                <div class="controls">
                                    {{ form.section }}
                                </div>
                            </div>
							{% endif %}
                            <div class="control-group bm_faded" id="id_section_categories"  style="display:{% if bz_obz.object_id %}block{% else%}block{% endif %};">
                                <label class="control-label" >Categories</label>
                                <div class="controls">
                                    <select id="id_category" class="iSp8 bM-sLt" data-placeholder="Select a Category" data-size="8" name="category" autocomplete="off">
                                              {% include 'banners/staff/load-categories.html' %}
                                            </select>
                                </div>
                            </div>
                            <div class="control-group {% if banner_obj %}bm_faded{% endif %}">
                                <label class="control-label" >Zone/Type<em class="cLr-rEd">*</em></label>
                                <div class="controls">
                                    {{ form.zones }}
								<span class="help-block">{% trans 'Select a banner zone/type.' %}</span>
                                </div>
                            </div>
							<!--div class="control-group" id="available_zones_div">
                                <label class="control-label" >Available Zones<em class="cLr-rEd">*</em></label>
                                <div class="controls" style="padding: 15px 20px;">
                                    {% for bz in banner_zones %}
                                            <ul>
                                                <li><span>Name:</span>{{bz.name}}</li>
                                                <li><span>Width:</span>{{bz.width}}px</li>
                                                <li><span>Height:</span>{{bz.height}}px</li>
                                            </ul>
                                     {% endfor %}
                                </div>
                            </div-->
							<div class="control-group">
                                <label class="control-label" >Open in a new window<em class="cLr-rEd">*</em></label>
                                <div class="controls">
                                    {{ form.is_new_tab }}
                                </div>
                            </div>
							<div class="control-group">
                                <label class="control-label" >Upload Banner<em class="cLr-rEd">*</em></label>
                                <div class="controls">
                                    {{ form.is_script }}
                                </div>
                            </div>
                            <div class="control-group" id="id_upload_banner_div" style="display:{% if banner_obj and banner_obj.is_script %}none;{% else %}block;{% endif %}">
                                <div class="controls">
                                    <input type="hidden" value="{% if form.instance.image %}1{% else%}0{% endif %}" id="id_img_hidden_field">
                                    {% if form.instance.image and not form.errors %}
                                        <div style="width:100px; position:relative;">
                                            <a href="javascript:void(0);" onclick="banner_image_large_preview('{% url 'staff_banners_banner_image_preview' %}?bid={{banner_obj.id}}','{{banner_obj.caption}}');" title="{% trans 'Large Preview' %}" ><img src="{{banner_obj.image.url}}"  width="100" /></a>
                                            <span id="rm_image" onclick="if(confirm(gettext('Are you sure you want to delete the banner?'))){remove_uploaded_banner($(this),'{{banner_obj.id}}');return false;}" style="background:url('{{STATIC_URL}}ui/images/icons/c/97-C3.png') no-repeat scroll 50% center transparent; width:16px; height:16px; display:block;position:absolute; top:0; right:0; cursor:pointer;"></span>
                                        </div>
                                    {% endif %}    
                                    <div id="id_upload_imgae_div" {% if not form.errors and form.instance.image %}style="display:none;"{% endif %}>{{form.image}}</div>
                                </div>
                            </div>
							<div class="control-group" id="id_script_banner_div" style="display:{% if banner_obj and banner_obj.is_script %}block;{% else %}none;{% endif %}">
                                <label class="control-label" >Script Code<em class="cLr-rEd">*</em></label>
                                <div class="controls">
                                    {{ form.banner_script }}
                                </div>
                            </div>
							<div class="control-group">
                                <label class="control-label" >Destination URL</label>
                                <div class="controls">
                                    {{ form.destination_url }}
                                </div>
                            </div>
							<div class="control-group mRb0" id="id_banner_payment_div">
							{% include 'banners/user/load-banner-payments.html' %}
							</div>

							<div class="control-group mRb0" id="id_aready_paid" style="display:none;">
                                <label class="control-label" >Already Paid:</label>
                                <div class="controls mRt2 pDt5">
									{{globalsettings.currency}}{{already_paid}} for {{banner_obj.impressions}} impressions
                                </div>
                            </div>
							<div class="control-group mRb0" id="id_you_pay" style="display:none;">
                                <label class="control-label" >You Pay:</label>
                                <div class="controls mRt2 pDt5">
									{{globalsettings.currency}}<span id="bnr_cal_span">{{banner_obj.total_amount}}</span> - {{globalsettings.currency}}{{already_paid}} = {{globalsettings.currency}}<span id="id_you_data_pay"></span>
                                </div>
                            </div>
							
							<div class="control-group" id="payment_options" style="display:{% if not banner_obj %}block;{% else %}none;{% endif %}">
                                <label class="control-label" >Payment mode<em class="cLr-rEd">*</em></label>
                                <div class="controls pDt5">
                                    <input type="radio" name="payment_mode" value="online" checked> Online 
									<input type="radio" name="payment_mode" value="offline"> Offline
                                </div>
                            </div>
                            <hr class="oTsT-hRz20 mRb0">
                            <div class="row-fluid">
                                <div class="form-actions pD0 pLrT">
                                    <a href="{% url 'user_banners_manage_banners' %}" class="btn btn-light fS12 fW-bLd ">Cancel</a>
                                    <button value="save" name="draft" type="submit" class="btn btn-danger fS12 fW-bLd ">Submit</button>
                                </div>
                            </div>
                        </form>
					</div>
				</section>
			</div> <!-- /.main -->
			<aside class="sD-bR span3">
				<div>
					<section class="tXt-cTr pD0 bNr-aD"> 
                       
                    </section>
				</div>
			</aside>
		</div>  <!-- /.row-fluid -->
	</div>  <!-- /.span10 -->
{% endblock %}

{% block footerarea %}

	{% upload_js %}
	<script type="text/javascript" src="{{STATIC_URL}}js/jquery/bm.jfp.js"></script>
	<script type="text/javascript" src="{{STATIC_URL}}js/jquery/bm.fup.appln.js"></script>

<script type="text/javascript">
function enable_impression(){
$('.iSp8').removeClass("bm_faded");
$('#payment_options').css('display','block');
$('#id_aready_paid').css('display','block');
}


$(document).ready(function(){
				$('.bM-sLt').doThis(function(){
					this.bUiSlCt();
				});

    $('#id_destination_url').focusin(function(){
        if($('#id_destination_url').val()==""){
                $('#id_destination_url').val('http://www.');
        }
          
    });
    $('#id_destination_url').focusout(function(){
    if($('#id_destination_url').val()=='http://www.'){
                $('#id_destination_url').val('');
            $(this).parent('div').parent('div').removeClass('field-error');$('#id_destination_url').removeClass("error");    
            }
    });
    
    $.validator.addMethod("img_required", function(value, element) {  
        //if($('#id_is_script_1').is(':checked')){return false;}      
        if($('#id_is_script_1').is(':checked')){if($('#id_img_hidden_field').val()=='0'){if($.trim($('#id_image').val())==''){return false;}else{return true;}}else{return true;}}                                                       
        else{return true;}
    },"Please upload image.");
    $.validator.addMethod("script_required", function(value, element) {  
        if($('#id_is_script_0').is(':checked')){if($.trim($('#id_banner_script').val())==''){return false;}else{return true;}}                                                                
        else{return true;}
    },"Please enter banner script.");
    $.validator.addMethod("time", function(value, element) {  
    return this.optional(element) || /^(([0]?[1-9])|([1][0-2])):([0-5]?[0-9])(:([0-5]?[0-9]))?\s([AP][M])$/i.test(value);},gettext("Please enter a valid time."));
    $("#mform").validate({
        ignore:'',
			highlight: function(element, errorClass){
				$(element).parent('div').parent('div').addClass('error');
				$(element).parent('div').addClass('error');
				$(element).addClass('error');
			},
			unhighlight: function(element, errorClass){
				$(element).parent('div').parent('div').removeClass('error');
				$(element).parent('div').removeClass('error');
				$(element).removeClass('error');
			},
        errorPlacement: function(error, element){},
		invalidHandler: function(event, validator) { 
			var id = $(validator.errorList[0].element).parent('div');
			$('html,body').animate({ scrollTop: $(id).offset().top }, 'slow');
		},
           rules:{
            caption: "required",
			n_impressions: {required:true,number:true},
            zones: "required",
            section:"required",
            image:"img_required",
            banner_script:"script_required",
            //expiry_date:"required",
            destination_url:{required:false,url:true},
			{% if not banner_obj %}payment_mode:"required"{% endif %}
           },
    });
    
    $('.select-menu').bind("change", function(){
            $("#mform").validate().element($(this));
    });
	
	$('#id_section').bind("change", function(){
            $("#mform").validate().element($(this));
    });
	$('#id_zones').bind("change", function(){
            $("#mform").validate().element($(this));
    });
    
    /*$('#id_banner_script').bind("keyup", function(){
            $(this).removeClass('error');$(this).parents('div').eq(2).removeClass('field-error');                        
    });*/
    
    {% if banner_obj or form.errors %}load_categories();update_banner_pricing($('#id_zones').val());{% endif %}
    {% if not banner_obj %} $('#id_zones option').remove();$('#id_zones').trigger("liszt:updated"); {% endif %}
    {% if form.errors %} load_banner_zones(); {% endif %}

	{% if form.errors %}
		update_banner_pricing({{form.instance.zones_id}});
		$('#id_img_hidden_field').val('0');
		$('#id_upload_imgae_div').show();
	{% endif %}
   
});

function select_banner_upload_choice(value){
   if(value=='False'){$('#id_script_banner_div').hide();$('#id_banner_script').val('');$('#id_upload_banner_div').fadeIn(300);}
   else{$('#id_upload_banner_div').hide();$('#id_image').val('');$('#id_script_banner_div').fadeIn(300);}
}

function check_form_is_valid(){
   //ev.preventDefault();                                
   //evt.stopPropagation();                          
   var success = $('#mform').validate().form();
   if (success){return true;} 
   else{return false;} 
}
function load_categories(){
        $('#id_section_categories').addClass('bm_faded');
        var datastring = 'module='+$("#id_section option:selected").text();
        {% if banner_obj %}datastring+='&bid={{banner_obj.id}}';{% endif %}
        {% if selected_category %}datastring+='&selected_category={{selected_category}}';{% endif %}
        $.ajax({
        type: "GET",
        url: '{% url 'staff_banners_ajax_load_banner_categories' %}',
        data: datastring,
        dataType:'JSON',
        success: function(data){
            if(data.status){$('#id_section_categories').removeClass('bm_faded');$('#id_category').empty().append(data.html)}
            else{$('#id_category').empty();}
            $('#id_category').bUiSlCt("refresh");
            },
            error: function(data){
               $('#id_category').empty();                   
               alert('Oops!! Cannot process your request.');
            }
        });
}

function load_banner_zones(){
    var datastring = 'module='+$("#id_section").val();
    {% if selected_zone %}datastring+='&selected_zone={{selected_zone}}';{% endif %}
    $.ajax({
    type: "GET",
    url: '{% url 'staff_banners_ajax_load_banner_zones' %}',
    data: datastring,
    dataType:'JSON',
    success: function(data){
        if(data.status){$('#id_zones').empty().append(data.html)}
        else{$('#id_zones').empty()}
        $('#id_zones').bUiSlCt("refresh");
        },
        error: function(data){
           $('#id_zones').empty();                   
           alert('Oops!! Cannot process your request.');
        }
    });
                             
}

function update_banner_pricing(zid){
    var datastring = 'zone='+zid;
    {% if banner_obj %}datastring+='&bid={{banner_obj.id}}';{% endif %}
    {% if total_impression %}datastring+='&total_impression={{total_impression}}';{% endif %}
    {% if total_amount %}datastring+='&total_amount={{total_amount}}';{% endif %}
    $.ajax({
    type: "GET",
    url: '{% url 'user_banners_ajax_load_banner_payment' %}',
    data: datastring,
    dataType:'JSON',
    success: function(data){
        if(data.status){
			$('#id_banner_payment_div').empty().append(data.html);
			{% if banner_obj %}
				enable_impression();
			{% endif %}
		}else{
			$('#id_banner_payment_div').empty()
		}
        //setTimeout(function() {$('.bnr-slct').chosen(); }, 500);
        },
        error: function(data){
           $('#id_banner_payment_div').empty();                   
           alert('Oops!! Cannot process your request.');
        }
    });
}

function calculate_total_price(selected,price,impressions){
        var total;
		var you_pay;
        if (selected == '0'){total = price;} 
        else{total = (selected*price)/impressions;}
        $('#bnr_total_span').html(total);
        $('#bnr_total_span').empty().html(' {{globalsettings.currency}} '+total);  
        $('#id_total_amount').val(total);  
        $('#id_total_impression').val(selected);
		{% if banner_obj %}
			$('#bnr_cal_span').html(total);
        	$('#bnr_cal_span').empty().html(total);
			you_pay = total - {{already_paid}};
			if(you_pay<=0){
				$('#id_you_data_pay').html(0.0);
			}else if(you_pay < 1){
				$('#id_you_data_pay').html(1.0);
			}else{
				$('#id_you_data_pay').html(you_pay.toFixed(2));
				var pay_imp = selected-{{banner_obj.impressions}}
				if(pay_imp>0){
					$('#id_you_data_pay').append(' for '+pay_imp+' more impression(s).');
				}
			}
			$('#id_you_pay').css('display','block');
		{% endif %}
}

function remove_uploaded_banner(hobj,bid){
  $.get("{% url 'user_banners_ajax_delete_banner_image' %}",{ bid: bid },function(data){
         if(data=='1'){$(hobj).parent('div').fadeOut('slow').remove();$('#id_img_hidden_field').val('0');$('#id_upload_imgae_div').show();}
         else{alert('Oops..!! error while deleting logo');}
  });
}

function show_shaan(){
   $('#available_zones_div').fadeIn('slow');                
}
</script>
{% endblock %}