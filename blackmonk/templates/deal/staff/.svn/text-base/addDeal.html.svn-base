{% extends "staff_base.html" %}
{% load tabs %}
{% load i18n %}
{% load ds_utils %}
{% load thumbnail %}
{% load upload_tags %}
{% block navigation %}
	{% activetab "selmodule" "deals" %}
	{{ block.super }}
{% endblock %}
{% block pagetitle %}{% if deal %}{% trans 'Edit Deal' %}{% else %}{% trans 'Deals - Add New Deal' %}{% endif %} {% endblock %}
{% block head %}
		<link type="text/css" rel="stylesheet" href="{{STATIC_URL}}css/bm.jfp.ui.css">
		<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}themes/green/css/LE_MetaId99.css">
		<link rel="stylesheet" type="text/css" href="{{STATIC_URL}}ui/css/jquery.tagit.css">		
{% endblock %}
{% block content %}
<div id="staff-platform" class="group">
                    <div class="header-bar {% if deal %}has-preview-head{% endif %}">
                    	<h2><a href="{% url 'staff_deals_home' %}"><span class="go_back"></span></a>{% if deal %}{% trans 'Edit Deal' %}{% else %}{% trans 'Add Deal' %}{% endif %}</h2>
                      	{% if deal %}
	                    <section class="sub-header-bar">
							<div class="preview-head">
                            	{% if deal.featured %}
				        		<span class="list-type featured-item"><a class="tttxt" original-title="{% trans 'Item listed as featured' %}" href="javascript:void(0);">{% trans 'Featured' %}</a></span>
						 		{% endif %}
                                <div class="item-title">
                                    <h1>{{ deal.title|truncatechars:80 }}</h1>
                                    <p class="ltxt80">By <a href="{% url 'user_profile' deal.created_by.profile_slug %}">{{deal.created_by.get_full_name}}</a> <span class="divider12">|</span> {{deal.created_on|date:"M d, Y"}}</p>
								</div>                                   
                                <ul class="status-tabs group">
                                    <li>{{deal.most_viewed}}<span class="meta">{% trans 'views' %}</span> </li>
                                    <!--li><a href="#">0<span class="meta">{% trans 'comments' %}</span></a> </li-->
                                </ul>                                
                            </div>  
	                    </section>                           
						{% endif %}
					</div>
                    <div id="core-wraper" class="group">
                        <div class="staff-main">
                            <div class="page-wrap">
                                <div id="deals-add" class="group">
                                    <div id="add-new-deal">
                                    	{% if form.errors %}
										<div class="messageerror" style="background:#FCF4F4;padding:10px;color:#FF9902; box-shadow:0 0 2px rgba(0, 0, 0, 0.1);border-bottom:1px solid #e1e1e1">
											<strong style="font-weight:bold;">{% trans 'There is a problem with your submission' %}</strong>
										    <ul style="list-style:square;margin-left:20px;">
										   		{% for field in form %}
										   			{% if  field.errors%}<li>{%for error in field.errors%}{{error}}{%endfor%}</li>{% endif %}
										  	 	{% endfor %}
											</ul>
										</div>
										{% endif %}
                                        <form action="{% url 'staff_deals_add_deal' %}{% if deal %}?did={{deal.id}}{%endif%}" enctype="multipart/form-data" onsubmit="return validate_category()" name="mform1" id="mform1" method="post" class="add_venue">{% csrf_token %}
                                            <div class="fields hform">
                                                <div class="field-group">              
                                                    <div class="field text-field fd-title">
                                                        <div class="label"><label for="">{% trans 'Deal Title' %}<span class="required-field">*</span></label></div>
                                                        <div class="value">
                                                           {{ form.title }}
                                                        </div>
                                                    </div>
                                                    {% include 'common/coverphoto_form_staff.html' %}
                                                    <div class="field select-field">
                                                        <div class="label"><label for="">{% trans 'Category' %}<span class="required-field">*</span></label></div>
                                                        <div class="value">
																{{ form.category }}
                                                        </div>
                                                    </div>
                                                    <div class="field text-field">
                                                        <div class="label"><label for="-button">{% trans 'Deal starts from' %}<span class="required-field">*</span></label></div>
                                                        <div class="value">
															<div class="fd-cols mrb0 group">
                                                            	<span class="has-fd-icon pdr6">{{ form.start_date }}
                                                                	<img class="fd-icon" src="{{STATIC_URL}}ui/images/icons/b/70.png" alt="">
                                                                </span>
                                                                <span>{% trans 'to' %}</span>
                                                            	<span  class="has-fd-icon pdr6">{{ form.end_date }}
                                                                	<img class="fd-icon" src="{{STATIC_URL}}ui/images/icons/b/70.png" alt="">
                                                                </span>
															</div>
                                                        </div>
                                                    </div>
                                                            
                                                    <div class="field text-field">
                                                        <div class="label"></div>
                                                        <div class="value">
                                                            <div class="group">
                                                                <span class="inline-block pdr6 fs">
                                                                    <label for="">{% trans 'Market Price' %}({{ globalsettings.currency }})<span class="required-field">*</span></label>
                                                                   {{ form.original_price }}
                                                                </span>
                                                                <span class="inline-block fs">
                                                                    <label for="">{% trans 'Deal/Sale Price' %}({{ globalsettings.currency }})<span class="required-field">*</span></label>
                                                                    {{ form.discount_price }}
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="field text-field">
                                                        <div class="label"><label for=""></label>{% trans 'Deal Image' %}</div>
                                                        <div class="value">
                                                           <div id="fileupload" >
							 									<div class="fileupload-content">
							    									<ul class="files bm-uploader-list"></ul>
																</div><div class="clear"></div>
					    										<div id="bm-dropzone_area" class="dropzone">{% trans 'Drop the files here' %}</div>
					            								{% csrf_token %}<div class="clear"></div>
					           									 <div class="upload-button-wrapper">
					               									 <a class="upload-button">{% trans 'Add Image' %}</a>
					                    							 <div class="fileinput-button">
					                        							 <input type="file" name="photo" id="id_photo" multiple=""  accept="image/*" tabindex="-1">
					                    							 </div>
					               								 </div>
															</div>
                                                        </div>
                                                    </div><div class="clear"></div>
                                                     <div class="field text-field">
                                                        <div class="label"><label for="">{% trans 'Deal description' %}<span class="required-field">*</span></label></div>
                                                        <div class="value">{{ form.about }}</textarea></div>
                                                    </div> 
                                                </div> 
                                                <div class="field-group">
                                                    <div class="fields-head">
                                                    <h3>{% trans 'Fine print' %}</h3>
                                                    <!--p class="ltxt80">{% trans 'Each additional website added to your account costs $10/month. To see the total cost for all sites on your account, visit the' %} <a href="#">{% trans 'Billing page' %}</a>.</p-->
                                                    </div>
                                                    <div class="field text-field">
                                                        <div class="label"></div>
                                                        <div class="value">
                                                            <div class="group">
                                                                <span class="inline-block pdr6 fs">
                                                                    <label for="">{% trans 'Max no. of Deals' %}<span class="required-field">*</span></label>
                                                                    {{ form.max_count }}
                                                                </span>
                                                                <span class="inline-block fs">
                                                                    <label style="display:block; margin-bottom:2px;" for="">{% trans 'Limit per customer' %}<span class="required-field">*</span></label>
                                                                    {{ form.limit_per_customer }}
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="field text-field">
                                                        <div class="label"><label for="">{% trans 'Voucher valid' %}<span class="required-field">*</span></label></div>
                                                        <div class="value has-fd-icon">
                                                            		{{ form.voucher_valid }}
                                                                    <img class="fd-icon" src="{{STATIC_URL}}ui/images/icons/b/70.png" alt="">
                                                        </div>
                                                    </div>
                                                    <div class="field text-field">	
                                                        <div class="label"><label for="-button">{% trans 'Gift options' %}</label></div>	
                                                        <div class="value">
                                                        	<div class="fd-cols mrb0 pd50 group cr_wmr_2">
                                                                <span class="pdr6">{{ form.can_gifted }}</span> 
															</div>                                                                
														</div>	
                                                    </div>
                                                    <div class="field text-field">
                                                        <div class="label"><label for="">{% trans 'Fine print' %}</label></div>
                                                        <div class="value">{{ form.fineprint }}</div>
                                                    </div> 
                                                </div><!--/field-group-->  
                                                <div class="field-group"> 
                                                	 <div class="fields-head">
                                                     <h3>{% trans 'Deal Highlights' %}</h3>
                                                    </div>
                                                    <div class="field text-field">
                                                        <div class="label"><label for="">{% trans 'Deal Highlights' %}</label></div>
                                                        <div class="value">{{ form.hihlights }}</textarea></div>
                                                    </div> 
                                                </div><!--/field-group-->
                                                <div class="field-group"> 
                                                	 <div class="fields-head"></div>
													<div class="field text-field">
                                                        <div class="label"><label for="">{% trans 'Address' %}<span class="required-field">*</span></label></div>
                                                        <div class="value has-fd-icon">
                                                          <div class="group" id="evnt_vnu" {% if add %}style="display: none;"{% endif %}>
	                                                    	<div class="fd-cols">
	                                                    		<input type="text" class="fl" placeholder="{% trans 'Type to search an address' %}"  value="{% if add %}{{add.address1}}{% endif %}" name="buss_addr" id="id_buss_addr">
	                                                            <img alt="" src="{{STATIC_URL}}ui/images/icons/b/87.png" class="fd-icon">	
	                                                    	</div>
	                                                    	<span>
                                                            <span class="tttxt-w tool-tip" title="{% trans 'Please search for the Business to make sure you are not submitting a duplicate entry.' %}">?</span>
															<a href="{% url 'staff_deal_add_address' %}" title="Add a new Address" class="add-venue txt-button business_link">{% trans 'Add a new Address' %}</a>                                                            	
                                                       		</span>
                                                       		</div>
                                                       		<div style="padding:5px 0 0; display: none"  id="ajax_venue_loading">
																<img src="{{STATIC_URL}}ui/images/global/loading-s.gif">
															</div> 
															<div class="field text-field" id="address_info">
		                                                    	{% if add %}
		                                                    		{% include 'deal/staff/ajax-address.html' %} 
																{% endif %}							
		                                                    </div> 
                                                            
                                                        </div>
                                                        
                                                    </div>
													
													
                                                </div><!--/field-group-->
												<!--/field-group-->
												<div class="field-group">
													<div class="fields-head"></div>
													<div class="field text-field">
														<div class="label">
															<label for="">{% trans 'Merchant User' %}<span class="required-field">*</span></label>
														</div>
														<div class="value has-fd-icon">
															<div class="group" id="deal_merchant" {% if form.instance.merchant.id %}style="display: none;"{% endif %}>
																<div class="fd-cols">
																	<input type="text" class="fl" placeholder="{% trans 'Type to search an user' %}" value="{{form.instance.merchant.useremail}}" name="merchant_search" id="id_merchant_search">
																	<img alt="" src="{{STATIC_URL}}ui/images/icons/b/87.png" class="fd-icon">
																</div>
															</div>
															<div style="padding: 5px 0 0; display: none" id="ajax_venue_loading">
																<img src="{{STATIC_URL}}ui/images/global/loading-s.gif">
															</div>
															<div class="field text-field" id="merchant_info">
															{% if form.instance.merchant.id %}
																<div id="merchant_block">
																    <input type="hidden" name="merchant" id="id_merchant" value="{{form.instance.merchant.id}}"/>
																    <div class="group address_block">
																        <div class="action">
																            <span>
																                <span style="margin-bottom:5px;" onclick="clear_merchant();" role="button" title="Remove" class="icon-remove inline-block o3"></span>
																            </span>
																        </div>
																        <div class="address">
																            <p class="venue-address">{{form.instance.merchant.display_name}}</p>
																            <p class="venue-contact"><span>Email:</span> {{form.instance.merchant.useremail}}</p>
																        </div>
																    </div>
																</div>
															{% endif %}
															</div>
														</div>
													</div>
												</div>
												<!--/field-group-->
											</div> 
                                            <div class="form-submit right group">
                                               <button class="cform-button" onclick="location.replace('{% url 'staff_deals_home' %}')" type="button" roll="button"><span class="cform-button-text">{% trans 'Cancel' %}</span></button>
                                               <button role="button" class="cform-button prime id_deal_submit" type="submit"><span class="cform-button-text">{% trans 'SAVE' %}</span></button>
                                            </div>                                                
                                        </form>
                                    </div>																	                                        
                                </div> <!-- end table -->                                    
                            </div><!-- end page wrap -->
                        </div>  <!-- end main-col -->                            
                        <div id="aside" class="side-bar">
                        	{% if deal %}
							<div class="preview-aside-meta group">
								<div class="preview-item-stats">
									<a href="{% url 'staff_deal_preview' deal.id %}" class="btn-txt-blue" style="display:block; text-align:center"><span class="btn-txt">{% trans 'Preview this Deal' %}</span></a>
                                </div>                                
							</div>  
							{% endif %}
							{% include 'deal/staff/add-deals-faq.html' %}                                                                
                        </div>                            
					</div>                                                    
				</div>
{% endblock %}
{% block footer_include%}
	<script type="text/javascript" src="{{ STATIC_URL }}js/jquery/jquery.validate.min.js"></script>
	<script type="text/javascript" src="{{STATIC_URL}}js/jquery/bm.common.js"></script>
	<script type="text/javascript" src="{{ STATIC_URL }}js/jquery/jquery.ui.datepicker.js"></script>
	<script type="text/javascript" src="{{STATIC_URL}}ui/js/jquery.ui.autocomplete.js"></script>
	<script type="text/javascript" src="{{ STATIC_URL }}js/ckeditor4/ckeditor.js"></script>
	<script type="text/javascript" src="{{ STATIC_URL }}js/deal/deals_staff.js"></script>
	
	{% upload_js %}
	<script type="text/javascript" src="{{STATIC_URL}}js/jquery/bm.jfp.js"></script>
	<script type="text/javascript" src="{{STATIC_URL}}js/jquery/bm.fup.appln.js"></script>
	<script type="text/javascript" src="{{STATIC_URL}}js/cropper.js"></script>
	<script src="http://maps.googleapis.com/maps/api/js?v=3&sensor=false{% if globalsettings.google_map_key %}&key={{ globalsettings.google_map_key }}{% endif %}" type="text/javascript"></script>
	<script type="text/javascript" src="{{STATIC_URL}}js/general/google_map.js"></script>
	
<script type="text/javascript">
	var edt;
	$(document).ready(function(){

			file_upload('{% url 'staff_deal_ajax_upload_photos' %}{%if deal.id%}?id={{deal.id}}{%endif%}',5);
			{% with form.instance|content_type as ctype %}
			cover_photo_upload("{% url 'common_upload_cover_photo' %}?ctype={{ctype.pk}}&cobj={{form.instance.id}}", 100/70);
			{% endwith %}
			/*$('#fileupload').bind('fileuploadstart', function (e, data) {
				$('.upload-button-wrapper').hide();
			});
			$('#fileupload').bind('fileuploaddestroy', function (e, data) {
				setTimeout(function(){
					$('.upload-button-wrapper').show();
					$('.upload-button').html(gettext('Add Images'));
				},700);
				setTimeout(function(){$('.upload-button').html(gettext('Add Images'));},1050);
				
			});*/
			{% if not deal %}
			{% if new_pic %}
				get_images('{% url 'staff_deal_ajax_get_default_photos' %}?ids={% for np in new_pic %}{{np}}{% if not forloop.last %},{% endif %}{% endfor %}')
			{% endif %}
			{% endif %}
			
			{% if deal %}
				$('.form-submit').addClass('form-submit-original');
				easy_form_submit();
			{% endif %}		
			
			$( "#id_buss_addr" ).autocomplete({
					source: '{% url 'staff_deal_address_suggest' %}',
				   	select: function(event, ui) {
		     			get_address(ui.item.id);
		     	 	}
				});
			$( "#id_merchant_search" ).autocomplete({
				source: '{% url 'staff_deal_merchant_suggest' %}',
				select: function(event, ui) {
	     			get_merchant(ui.item);
	     	 	}
			});
			if($("#id_start_date").length){
    			$("#id_start_date").datepicker({ dateFormat: "dd/mm/yy" , minDate: new Date(),
                    onSelect: function(){
                        $(this).valid();
                        enddate = $(this).val();
                        splittedval = enddate.split('/');
                        var date = new Date(splittedval[2], splittedval[1]-1, splittedval[0]);
                        date.setDate(date.getDate() + 1);
                        $("#id_end_date").datepicker( "option", "minDate", date );
                        var voucherdate = new Date(splittedval[2], splittedval[1]-1, splittedval[0]);
                        voucherdate.setDate(voucherdate.getDate() + 2);
                        $("#id_voucher_valid").datepicker( "option", "minDate", voucherdate );
                    }
                });
			}
			if($("#id_end_date").length){
				$("#id_end_date").datepicker({
					dateFormat: "dd/mm/yy",
					minDate: new Date(),
					onSelect: function(){
						$(this).valid();
						enddate = $(this).val();
						splittedval = enddate.split('/');
						var voucherdate = new Date(splittedval[2], splittedval[1]-1, splittedval[0]);
                        voucherdate.setDate(voucherdate.getDate() + 1);
                        $("#id_voucher_valid").datepicker( "option", "minDate", voucherdate );
					}
				});
			}
            if($("#id_voucher_valid").length){
	            {% if deal %}
					edit_enddate = $("#id_end_date").val();
					splittedval = edit_enddate.split('/');
					var voucherdate = new Date(splittedval[2], splittedval[1]-1, splittedval[0]);
		            voucherdate.setDate(voucherdate.getDate() + 1);
				{% endif %}
                $("#id_voucher_valid").datepicker({ dateFormat: "dd/mm/yy", minDate: {% if deal %}voucherdate{% else %}new Date(){% endif %}, onSelect: function() { $(this).valid();} });
            }

			$.validator.addMethod(
			    "hasDatepicker",
			    function(value, element) {
			        // yyyy-mm-dd
			        var re = /^(0[1-9]|1\d|2\d|3[01])\/(0[1-9]|1[0-2])\/(19|20)\d{2}$/;
			        // valid if optional and empty OR if it passes the regex test
					return re.test(value);
			    }
			);
			$("#mform1").validate({
			ignore:'',
			highlight: function(element, errorClass){$(element).parent('').parent('').addClass('field-error');$(element).addClass("error");},
			unhighlight: function(element, errorClass){$(element).parent('').parent('').removeClass('field-error');$(element).removeClass("error");},
			errorPlacement: function(error, element){},
		   	rules:{
		    	title: "required",
				category: "required",
		    	start_date: "required",
		    	end_date: "required",
		    	voucher_valid: "required",
		    	about: "required",
		    	buss_addr: "required",
		    	merchant_search: "required",
		    	ticket_site: {url: true},
		    	contact_email: {email: true},
    			original_price: {
    				required: true,
    				number: true
    				},
    			discount_price: {
    				required: true,
    				number: true
    				},
    			max_count: {
    				required: true,
    				digits: true
    				},
    			limit_per_customer: {
					required: true,
    				digits: true
    				}				
		   		},
				submitHandler: function(form) {
					$('.id_deal_submit').attr('disabled','disabled');
					$('.id_deal_submit').css('opacity',0.5);
					form.submit();
				}	
			});
			
			$( ".id_deal_submit" ).click(function(event){
				setTimeout(function(){
					$('.id_deal_submit').removeAttr('disabled');
					$('.id_deal_submit').css('opacity',1);
				},3000);
			});

			$('.select-menu').bind("change", function(){
				$("#mform1").validate().element($(this));
			});
				/*
				CKEDITOR.on( 'instanceCreated', function( e ){
                           e.editor.addCss('body { font-size:12px; font-family:Arial, "Times New Roman", Verdana;}');
            	 });
				*/
				edt=CKEDITOR.replace( 'id_about',
	                {                   
	                    customConfig : '{{ STATIC_URL }}js/ckeditor/custome_config.js',
	                    toolbar : 'Basic',
	                    width:500,height:130
	             });
	             ept=CKEDITOR.replace( 'id_fineprint',
	                {                   
	                    customConfig : '{{ STATIC_URL }}js/ckeditor/custome_config.js',
	                    toolbar : 'Basic',
	                    width:500,height:130
	             });
	             eht=CKEDITOR.replace( 'id_hihlights',
	                {                   
	                   
	                   customConfig : '{{ STATIC_URL }}js/ckeditor/custome_config.js',
	                    toolbar : 'Basic',
	                    width:500,height:130
	             });
				 edt.on('key', function(event) {updateTextArea();});
				 ept.on('key', function(event) {updateTextArea();});
				 eht.on('key', function(event) {updateTextArea();});
	});	
function updateTextArea(){
    CKEDITOR.tools.setTimeout( function(){ 
        $('#id_about').val(edt.getData());
        $("#id_about").trigger('keyup');
    }, 0);  
}	
</script>
<script type="text/javascript">
function get_address(bid){
	$('#evnt_vnu').hide();
	$('#ajax_venue_loading').show();
	$.ajax({
		   type: "GET",
		   url: '{% url 'staff_deal_get_address' %}',
		   data:"bid="+bid,
		   dataType:'JSON',
		  success: function(data){	
	   			if(data.status){
	   				$('#ajax_venue_loading').hide();
					$('#address_info').html(data.html);
				}else{show_msg(data.msg,data.mtype);}
				$(".add-venue").colorbox({width: "770",initialWidth: "800", top:"20", initialHeight: "200"});
		}
	});
}
function get_merchant(merch){
	var ahtml = "";
	ahtml += '<div id="merchant_block">';
	ahtml += '    <input type="hidden" name="merchant" id="id_merchant" value="'+merch.id+'"/>';
	ahtml += '    <div class="group address_block">';
	ahtml += '        <div class="action">';
	ahtml += '            <span>';
	ahtml += '                <span style="margin-bottom:5px;" onclick="clear_merchant();" role="button" title="Remove" class="icon-remove inline-block o3"></span>';
	ahtml += '            </span>';
	ahtml += '        </div>';
	ahtml += '        <div class="address">';
	ahtml += '            <p class="venue-address">'+merch.name+'</p>';
	ahtml += '            <p class="venue-contact"><span>Email:</span> '+merch.email+'</p>';
	ahtml += '        </div>';
	ahtml += '    </div>';
	ahtml += '</div>';
	$('#deal_merchant').hide();
	$('#merchant_info').html(ahtml);
}
function clear_merchant() {
	$('#id_merchant_search').val('');
	$('#merchant_block').remove();
	$('#deal_merchant').fadeIn();
}
function clear_business() {
	$('#id_buss_addr').val('');
	$('#id_ven_address_div').remove();
	$('#evnt_vnu').fadeIn();
}
function save_business(){
	get_lat_lang();
	var flag=$("#businessform").validate().form();
	if(flag){
		var dataString='venue='+$('#id_venue').val();
		dataString+='&city='+$('#id_city').val();
		dataString+='&address1='+$('#id_address1').val();
		dataString+='&address2='+$('#id_address2').val();
		dataString+='&zip='+$('#id_zip').val();
		dataString+='&telephone1='+$('#id_telephone1').val();
		dataString+='&mobile='+$('#id_mobile').val();
		dataString+='&website='+$('#id_website').val();
		dataString+='&fax='+$('#id_fax').val();
		dataString+='&email='+$('#id_email').val();
		dataString+='&lat_lng='+$('#lat_lng').val();
		dataString+='&zoom='+$('#zoom').val();
		$('#add_business').hide();
		$("#ajax_content_loading").show();
		$.ajax({
			   type: "POST",
			   url: $('#businessform').attr('action'),
			   data:dataString,
			   dataType:'JSON',
			   success: function(data){	
			   		if(data.status==1){
						$('#evnt_vnu').hide();
						$('#id_buss_addr').val('venue');
						$('#id_article_address').val('');
						$('#address_info').empty().html(data.html);
						$.colorbox.close();
					}
					else{
						$('div#add_business_overall').replaceWith(data.html);
						$('#add_business').show();
						$("#ajax_content_loading").hide();
						$.colorbox.resize();
					}
					$(".add-venue").colorbox({width: "770",initialWidth: "800", top:"20", initialHeight: "200"});
				}	
		});
	}
}
</script>
{% endblock %}							