{% load comment_config %}
{% load i18n %}
{% load thumbnail %}
{% load mptt_comments_tags %}
{% load_comment_config_obj object %}

{% if cc_comment_enabled %}
{% if cc_discuss_comment %}
    {% include 'general/disqus-comments.html' %}
{% else %}
    {% get_mptt_comment_count for object as comment_count %}
    <script type="text/javascript" src="{{ STATIC_URL }}js/jquery/jquery.validate.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}themes/js/jquery.raty.js"></script>
    <input type="hidden" value="{{object}}" id="id_comment_title" name="comment_title" />
	{% if appname == 'business' or appname == 'restaurants' or appname == 'movies' or appname == 'shop' %}
		<section class="sCn pD15">
        	<div class="sCn-tTl cLrFx mRb0">
            	<h3>
					<span id="id_comment_count" id_val="{{comment_count}}" class="mRt4 pLlT">{{comment_count}} {% trans 'Reviews' %}</span> 
					{% if user.is_authenticated  %}
						<a href="javascript:load_review()"  id="write_review_button" class="pLrT btn btn-primary fS12">Write your review</a>
					{% else %}
						<a href="javascript:load_review()" style="display:none;"  id="write_review_button" class="pLrT btn btn-primary fS12">Write your review</a>
						<a style="float:right;"  id="write_review_button_signin" href="{% url 'ajax_signin' %}?type=review" class="pLrT btn btn-primary fS12 bm-ajax-login">
							Write your review
						</a> 
					{% endif %}
				</h3>
			</div>
       	</section>
	{% else %}
		{% if appname != 'community' %}
        <div class="sCn-tTl">
            <h3><span id="id_comment_count" id_val="{{comment_count}}">{{comment_count}} {% trans 'Comments' %}</span></h3>
        </div>
		{% endif %}
	{% endif %}
    <ol class="cMnTs aVtR-cRcL mRb30" >
        <li class="cMnT-pSt" id="mptt-comments-tree">
            <div class="cMnT-pSt-iN" id="comment_from_holder" {% if appname == 'business' or appname == 'restaurants' or appname == 'movies' or appname == 'shop' %}style="display:none;{% endif %}">
				{% if appname != 'business' and appname != 'restaurants' and appname != 'movies' and appname != 'shop' %}
	                {% include "default/community/comments/form.html" %}
				{% endif %}
            </div>
        </li>
		<li class="cMnT-pSt">
			<div class="cMnTs-pNl-lDnG tXt-cTr" id="comment_from_div_loading_{{object.id}}" style="display:none;">
				<a class="btn btn-light btn-large btn-block fS13" href="javascript:void(0);">
					<span class="">
						<i alt="Loading icon" class="icon-spinner bUi-iCn-sPnR mRr5 fS16" aria-hidden="true"></i>
						<span class="bUi-sPnR-mSg cLr-gRy fS13">Loading...</span>
					</span>
				</a>
			</div>
		</li>
		<div id="id_load_ans_comment_{{object.id}}">
			
		</div>
    </ol> <!-- /.cMnTs -->

<script type="text/javascript">
function update_comment_button(hobj){
    var postBtn = $(hobj).parents(".dev-cForm").find('.dev-postBtn');
    if($.trim(hobj.val()).length >= 1){
        postBtn.removeAttr('disabled');
        postBtn.removeClass('disabled');
	}else{
    	postBtn.attr('disabled','disabled');
        postBtn.addClass('disabled');
	}
}
$(document).ready(function(){
{% if appname == 'business' or appname == 'restaurants' or appname == 'movies' or appname == 'shop' %}
	$('.dev-uraty').raty({
    	readOnly: true,
    	score: function() {return $(this).attr('data-score');}
	});
    $('.sTr-rT-aCt').raty({
    	precision: true,
      	target    : '.rT-sCr',
      	targetKeep: true,
      	hints: ['', '', '', '', ''],
      	size      : 16,
      	scoreName: 'ratings'
    });
{% endif %}
    
	$(".bm-ajax-login").colorbox({width: "681",initialWidth: "681", top:"5%",initialHeight: "360",onOpen: function(){$("#colorbox").addClass("no_title");},onComplete:colorboxonComplete});
});

	function load_parent_comment(hobj){
        //event.preventDefault();
        var thisElem=$(hobj);
		thisElem.closest('li').prepend($('#show_replay_loading').html())
        var dataString = 'parent_id='+$(hobj).attr('parent_id');
        $.ajax({
			type: "post",
            url: "{% url 'community_load_parent_comment' %}",
            data: dataString,
            dataType:'json',
            success: function(data){
				thisElem.closest('li').find('.show_replay_loading_div').remove()
                var pCElem= thisElem.parents(".dev-cMnT");
                pCElem.addClass("cLdRn");
                pCElem.before(data.html);
                thisElem.remove();  
            }
        });               
    }

	function save_reply_comment(hobj){
    	var id=$(hobj).attr('data_id');
        var thisElem=$(hobj);
        var formElem = $(hobj).parents('form');
        var dataString=formElem.serialize();
		dataString+='&reply=1';
        //dataString+='&rating=0';
        //try{dataString+='&parent_pk='+formElem.find(".rT-sCr").text();}catch(ex){}
        $.ajax({
        	type: "post",
            url: "{% url 'community_comments_post_comment' %}",
            data: dataString,
            dataType:'json',
            success: function(data){
            	if(data.status=='success'){
                	thisElem.parents(".dev-cRDiv").before(data.display_html);
                    thisElem.parents(".dev-cRDiv").remove();
					formElem.removeClass('hS-fCs')
					comment_count(data)
				}else if(data.status=='form_err'){
					$('div.comment_replay_form_'+id).empty().html(data.form_html).show();
                    $('#reply_ajax_content').show();
				}else{
                	$('#reply_ajax_content').show();
                    alert("Oops not able process your request!");
				}
			}
		});
	}

function load_recomment_form(hobj){
	//event.preventDefault();
    var cPid=$(hobj).parent().find("input[name=cid]").val();
    var thisElem=$(hobj);
    var dataString = 'c_id='+cPid
	thisElem.closest('li').append($('#show_replay_from_loading').html())
    $.ajax({
    	type: "POST",
        url: "{% url 'community_comment_reply' %}",
        data: dataString,
        dataType:'json',
        success: function(data){
			thisElem.closest('li').find('.show_replay_from_loading_div').remove()
        	if(data.status=='success'){
            	thisElem.parents(".dev-cParent").after(data.display_html);
                thisElem.remove();
                //$(".bm-ajax-login").colorbox({width: "681",initialWidth: "681", top:"5%",initialHeight: "360",onOpen: function(){$("#colorbox").addClass("no_title");},onComplete:colorboxonComplete});
			}else{alert("Oops not able process your request!");}
		}
	});
}

function save_comment_form(hobj,objid){
    	var formElem = $(hobj).parents('form');
        var dataString=formElem.serialize();
		$('#comment_from_div_loading_'+objid).show();
        $.ajax({
        	type: "POST",
            url: "{% url 'community_comments_post_comment' %}",
            data: dataString,
            dataType:'JSON',
            success: function(data){
				$('#comment_from_div_loading_'+objid).hide();
            	if(data.status=='success'){
					$('#write_review_button').empty().html('Edit your review');
                	var postBtn = formElem.find('.dev-postBtn');
                    postBtn.attr('disabled','disabled');
                    postBtn.addClass('disabled');
                    formElem.find("textarea[name=comment]").val("")
					formElem.removeClass('hS-fCs')
					{% if appname == 'business' or appname == 'restaurants' or appname == 'movies' or appname == 'shop' %}
						$("#comment_holder_ol_"+data.comment_id).remove();
						$('#comment_from_holder').empty().hide();
					{% endif %}
					$('#id_answ_comment_count_'+objid).html(parseInt($('#id_answ_comment_count_'+objid).text()) + 1);
                    $('#comment_remaining_div_'+objid).prepend(data.display_html);
					comment_count(data)
				}
				else if(data.status=='form_err'){alert("Oops not able process your submission!");}
				else{alert("Oops not able process your request!");}
			}
		});
	}
function colorboxonComplete(){
	setTimeout(function(){$(".bm-ajax-login").resize()},200);
}
function save_answer_comment(){
    save_comment_form($('#id_post_cmnt_btn_'+$('#id_ans_cmmt').val()), $('#id_ans_cmmt').val());
}

function load_community_more(objid){
    var dataString = 'content_type='+$('#id_content_type').val();
    //dataString+= '&object_pk='+$('#id_object_pk').val();
	//alert($('#page_'+objid).val());
	dataString+= '&object_pk='+objid;
	dataString+= '&page='+$('#page_'+objid).val();
    $('#comment_remaining_div_more_loading_'+objid).show();
    $('#comment_remaining_comm_p_'+objid).hide();
    $.ajax({
        type: "post",
        url: "{% url 'community_load_more_comment' %}",
        data: dataString,
        dataType:'json',
        success: function(data){
            $('#comment_remaining_div_more_loading_'+objid).hide();
            if(data.status=='success'){
				$('#comment_remaining_comm_p_'+objid).remove();
                $('#comment_remaining_div_'+objid).append(data.display_html);
                $('#comment_remaining_div_'+objid).show();
				$('#page_'+objid).val(parseInt($('#page_'+objid).val()) + 1);
            }
            else{
                $('#comment_remaining_comm_p_'+objid).show();
                alert("Oops not able process your request!");
            }
        }
    });
}
function like_dislike(id,cnt,type){
    var cnt = cnt + 1;
    $.ajax({
       type: "GET",
       url: "{% url 'comments_like_dislike' %}",
       data:"cid="+id+"&type="+type,
       dataType:'JSON',
       success: function(data){
           if (data.status=='working'){
                $('#cmnt_up_dwn_count_'+id).html(data.count);
	            $('#cmnt_up_dwn_count_'+id).attr('title',data.like_count+' up'+', '+data.dislike_count+' down');
            }
		} 
	});
}
function flag(id){
	$.ajax({
    	type: "GET",
       	url: "{% url 'comments_flag' %}",
       	data:"cid="+id,
       	success: function(data){
       		if (data=='1'){alert("Flagged");}
			else{alert("Already Flagged");} 
       }
    });
}
function expandtext(textArea,len){
	{% if appname == 'business' or appname == 'restaurants' or appname == 'movies' or appname == 'shop' %}len=2000;{% endif %}
    var txtvalue = textArea.value;
    var the_len = txtvalue.length;
    if (the_len > len){textArea.value = txtvalue.substring(0,len);}
    while(textArea.rows > 1 && textArea.scrollHeight < textArea.offsetHeight){textArea.rows--;}
	while (textArea.scrollHeight > textArea.offsetHeight){textArea.rows++;}
    textArea.rows++
}
function comment_count(data){
{% if not cc_approval %}
	if(data.review_flag && data.approved){
		var count = parseInt($('#id_comment_count').attr('id_val'));
		count=count+1;
		$('#id_comment_count').attr('id_val',count);
		$('#id_comment_count').html(count+' {% if appname == 'business' or appname == 'restaurants' or appname == 'movies' or appname == 'shop' %}{% trans "Reviews" %}{% else %}{% trans "Comments" %}{% endif %}');
	}
{% endif %}
	return true;
}
{% if appname == 'business' or appname == 'restaurants' or appname == 'movies' or appname == 'shop' %}
function load_review(){
	$('#comment_from_div_loading').show();
	$.ajax({
    		type: "GET",
           	url: "{% url 'load_review' object.id object|class_name %}",
           	dataType:'json',
           	success: function(data){
				$('#comment_from_div_loading').hide();
            	if(data.status=='success'){
                	$('#comment_from_holder').show();
                	$('#comment_from_holder').empty().html(data.display_html);
					$('[data-focus="true"]').doThis(function(){
						this.autoFocus();
						this.focus();
					});
					$('#comment_holder_ol_'+data.review).hide();
            	}else{alert('Oops!!! Not able to process your request.')}
           }
    });
}
function check_review(){
	$.ajax({
    		type: "GET",
           	url: "{% url 'check_review' object.id object|class_name %}",
           	success: function(data){
            	if(data=='1'){
                	$('#write_review_button').empty().html(gettext('Edit your review'));
            	}
           }
    });
}
{% if user.is_authenticated  %}check_review(){% endif %}
{% endif %}
</script>
{% endif %}
{% endif %}
<div id="show_replay_loading" style="display:none;">
<div class="cMnTs-pNl-lDnG show_replay_loading_div">
	<p class="bUi-sPnR">
		<i alt="Loading icon" class="icon-spinner bUi-iCn-sPnR mRr5 fS16" aria-hidden="true"></i>
		<span class="bUi-sPnR-mSg cLr-gRy fS13">Loading...</span>
	</p>
</div>
</div>
<div id="show_replay_from_loading" style="display:none;">
<div class="cMnTs-pNl-lDnG show_replay_from_loading_div" style="text-align:center;">
	<p class="bUi-sPnR">
		<i alt="Loading icon" class="icon-spinner bUi-iCn-sPnR mRr5 fS16" aria-hidden="true"></i>
		<span class="bUi-sPnR-mSg cLr-gRy fS13">Loading...</span>
	</p>
</div>
</div>