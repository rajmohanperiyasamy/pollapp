{% load thumbnail %}
{% load comparison %}
{% load truncate_filter %}
{% load i18n %}
{% load ds_utils %}
<!-- Ads and coupons listing start here -->
   <div class="row-fluid buz_block" id="buz_products" style="{% if view != 'products' or view_product %}display:none;{% endif %}">
        <div class="mRb30">
            <div class="sCn-tTl">
				<h3><span class="pLlT">{% trans 'Products' %}</span>
			{% if usr_editable %}
				<a href="{% url 'user_business_product_add' business.id %}" class="btn btn-small btn-danger fW-bLd pLrT" data-target="#addProduct">Add new product</a></h3>
			{% endif %}
            </div>
			{% with business.buz_product.all as productlist %}
            <ul class="mDa-gD fOcL mDa-oT-lT pDfX" id="id_pre_product">
                <li id="product_li_loading" class="mDa" style="display:none;">
                   <div class="mDa-iN">
                       <div class="mDa-wPr">
                           <a href="javascript:void(0);" class="bUi-tMb-wPr tMb-50">
                               <span class="bUi-tMb" style="background-color: rgb(238, 240, 243);">
                                   <span class="bUi-tMb-pRpL">
                                       <span class="bUi-tMb-cLp">
                                           <span class="bUi-tMb-cLp-iN">
                                               <img src="/static/ui/images/global/loading.gif">
                                               <span class="vRtL-aLn">
                                               </span>
                                           </span>
                                       </span>
                                   </span>
                               </span>
                           </a>
                       </div>
                   </div>
                </li>
                {% for pro in business.buz_product.all %}
                <li class="mDa" id="product_li_{{pro.id}}" itemscope itemtype="http://schema.org/Product">
                    <div class="mDa-iN bM-bX">
                        <div class="mDa-wPr"> 
                            <a class="bUi-tMb-wPr tMb-50 fLxiMgW"  href="javascript:{% if usr_editable %}void(0){% else %}show_block_detail('products',{{pro.id}}){% endif %};" >
                                <span class="bUi-tMb">
                                    <span class="bUi-tMb-pRpL">
                                        <span class="bUi-tMb-cLp">
                                            <span class="bUi-tMb-cLp-iN">
                                                <img class="mDa-oT" src="{% if pro.photo %}{% thumbnail pro.photo 285x0 %}{% else %}{{STATIC_URL}}themes/img/no-image.png{% endif %}" alt="{{ pro.title }}" title="{{ pro.title }}">
                                                <span class="vRtL-aLn">
                                                </span>
                                            </span>
                                        </span>
                                    </span>
                                </span>
                            </a> 
                        </div>
                        <div class="mDa-bDy pD15">
                            <h4 class="mDa-hD" title="{{ pro.title }}"><a href="javascript:{% if usr_editable %}void(0){% else %}show_block_detail('products',{{pro.id}}){% endif %};" itemprop="name">{{ pro.title }}</a></h4>
                            <div class="mDa-dTa">
                                <div class="fS11 cLr-dRk h30" itemprop="description">{% autoescape off %}{{ pro.description|striptags|truncate_chars:95 }}{% endautoescape %}</div>
                            </div>
                            {% if usr_editable %}
                            <div class="mRt10 cLrFx"><a class="fS12 cLr-gRy pLrT mRl10" href="javascript:delete_product({{pro.id}})">Delete</a><a href="{% url 'user_business_product_update' business.id pro.id %}" data-target="#addProduct" class="fS12 cLr-gRy pLrT">Edit</a></div>
                            {% endif %}
                        </div>
                    </div>
                </li>
                {% endfor %}
            </ul>
			<div class="hT360 rLvE" id="no-product" style="{% if productlist %}display: none;{% endif %}">
                <div class="tBl-bLk pDt0">
                   <div class="tBl-cEl">
                       <span class="iCn-bRdR80 oP75"><i aria-hidden="true" class="bUi-iCn-oFr-24 fS42-1 cLr-lTgRy ib"></i></span>
                       <p class="bLk mRt20 fS16 cLr-lTgRy ">You haven't added any Product yet.</p>
                   </div>
                </div>
            </div>
            {% endwith %}
        </div>
   </div>
<!-- Ads and coupons listing end  -->
        
<!-- Ads and coupons details start  -->
	<div id="id_pre_detail">
    {% for pro in business.buz_product.all %}
    <div class="row-fluid hide buz_block" id="buz_products{{pro.id}}" style="{% if view_product != pro.id %}display:none;{% else %}display:block;{% endif %}">
        <div class="span6 mRb30">
            <div class="sCn-tTl">
                <h3><span>{% trans 'Products' %}</span></h3>
            </div>
            <section class="sCn">
                <div class="row-fluid mRb30">
                    <a href="javascript:show_block('products')" title="{% trans 'back to Products' %}" class="btn btn-light pLlT"><i aria-hidden="true" class="bUi-iCn-aRw-l-16"></i></a>
                </div>
                <div class="sCn-tTl">
                    <h3 class="tRnCt0"><span>{{pro.title}}</span></h3>
                </div>
                <div class="dTs-cRd">
                    <div class="oTsT-hRz mRb20">
                        <div class="bUi-tMb-wPr">
                            {% if pro.photo %}<img class="mDa-oT" src="{% thumbnail pro.photo 600x0 %}" alt="{{pro.title}}" style="width:100%">{% endif %}
                        </div>
                    </div>
                    <div class="mRb20">
                        <h5 class="cLr-bLk hide">{% trans 'Description' %}</h5>
                        <div class="dSc sMl cLr-dRk">{% autoescape off %}{{ pro.description }}{% endautoescape %}</div>
                    </div>
                    <!--ul class="iCnC-lSt iCn12">
                        <li class="iCnC-lSt-iTm cLr-gRy fS13">
                            <i class="bUi-iCn-cLdR-12 iCn-rEd"></i> Starts June 1, 2013 - Expires July 31, 2013
                        </li>
                    </ul-->
               </div>
            </section>
        </div>
    </div>
    {% endfor %}
	</div>
{% if usr_editable %}
<!-- Ads and coupons details start  -->
<div id="addProduct" class="modal hide fade mW40" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 id="myModalLabel" class="mR50">Add New Product</h4>
    </div>
    <div class="modal-body">
    </div>
    <div class="modal-footer">
        <button class="btn btn-primary fS12 fW-bLd" type="button" onclick="save_product()">Save</button>
    </div>
</div>
<script type="text/javascript" src="{{STATIC_URL}}js/jquery/bm.jfp.js"></script>
<script type="text/javascript" src="{{STATIC_URL}}js/jquery/bm.fup.appln.js"></script>
<script src="{{ STATIC_URL }}js/ckeditor/ckeditor.js" type="text/javascript"></script>
<link type="text/css" rel="stylesheet" href="{{STATIC_URL}}css/bm.jfp.ui.css">
<script type="text/javascript" src="{{ STATIC_URL }}js/jquery/jquery.validate.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/common_user.js"></script>
<script type="text/javascript">
function config_edit_product(){
	$("a[data-target=#addProduct]").click(function(ev) {
	   ev.preventDefault();
	   target = $(this).attr("href");
	
	   // load the url and show modal on success
	   $("#addProduct .modal-body").load(target, function() {
	        $("#addProduct").modal("show");
	   });
	});
}
$(document).ready(function(){
    config_edit_product();
});
function save_product(){
	var flag = $('#mform').validate().form()
	if(flag==true){
		var dataString='&title=' +encodeURIComponent($('#id_title').val());
		dataString+='&description=' +encodeURIComponent(CKEDITOR.instances.id_description.getData());
		dataString+='&price=' +encodeURIComponent($('#id_price').val());
		$('#ajax_content_product').hide();
		$('#ajax_content_loading_product').show();
		$.ajax({
		type: "POST",
		url: $("#mform").attr("action"),
		data: dataString,
		dataType:'JSON',
		success: function(responseData){
				if(responseData.status){
					var id = responseData.id;
					var title = responseData.title;
					var description = responseData.description;
                    $("#product_id").val(responseData.id);
                    if(imageIsThere){$(".start").trigger('click');}
					$('#addProduct').modal('hide');
                    $('#product_li_loading').show();
                    $('#no-product').hide();
                    try{$('#product_li_'+id).remove();}
                    catch(e){}
                    setTimeout(function(){
                        $.ajax({
                            type: "POST",
                            url:"{% url 'user_biz_get_part_html' %}",
                            data: 'id='+id+'&type=product',
                            dataType: 'JSON',
                            success: function(responseData){
                                $(responseData.html).insertAfter("#product_li_loading");
                                $('#product_li_loading').fadeOut( "slow", function() {
                                    $('#product_li_'+id).fadeIn();
                                })
                                config_edit_product();
                            }
                        });
                    },2000);
				}else{
					alert("Sorry! Some error occurred");
				}
			}
		});
	}
}
function delete_product(id){
    if(confirm('Are you sure want to delete this product ?')){
        $.ajax({
            type: "POST",
            url:'{% url 'user_business_product_delete' %}',
            data:'id='+id,
            dataType:'JSON',
            success: function(responseData){
                if(responseData.status==1){
                    $('#buz_products'+id).remove();
                    $('#product_li_'+id).remove();
                    if($('ul#id_pre_product').find('li').length==1){
                        $('#no-product').show();
                    }
                }
            }
        });
    }
}
</script>
{% endif %}