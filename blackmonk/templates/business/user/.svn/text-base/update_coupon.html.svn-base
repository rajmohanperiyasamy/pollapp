{% load upload_tags %}
<div class="row-fluid">
	<form class="uSr-aCnT" id="mform" action="{% if coupon %}{% url 'user_business_coupon_update' business.id coupon.id %}{% else %}{% url 'user_business_coupon_add' business.id %}{% endif %}">
    	<div class="control-group mRb20">
            <div class="controls">
                <label class="radio inline fW-nRmL">
                    <input checked="checked" id="id_type_0" name="type" type="radio" value="C"> Coupon 
                </label>
                <label class="radio inline fW-nRmL">
                    <input id="id_type_1" name="type" type="radio" value="O"> Offer
                </label>
            </div>
        </div>
        {% if form.errors %}
			<ul>
				{% for field in form %}
			 		{% if field.errors%}<li>{%for error in field.errors%}{{error}}{%endfor%}</li>{% endif %}
				{% endfor %}
			</ul>
		{% endif %}
        <div class="control-group">
            <label class="control-label" >Title<em class="cLr-rEd">*</em></label>
            <div class="controls">
                {{form.title}}
            </div>
        </div>
        <div class="control-group mRb20">
            <label class="control-label" >Description<em class="cLr-rEd">*</em></label>
            <div class="controls">
                {{form.description}}
            </div>
        </div>
        <div class="control-group cLrFx">
            <label class="control-label">Coupon Start/End Date<em class="cLr-rEd">*</em></label>
            <div class="controls rLvE">
                <div class="controls"><div class="span4 sP6mP pLlTmP mRb6Mp">{{form.start_date}}</div></div>
                <div class="controls"><div class="span4 sP6mP pLlTmP mRb6Mp pDl6mP">{{form.end_date}}</div></div>
            </div>
        </div>
        <div class="control-group">
			<input type="hidden" name="pr_id" id="coupon_id" value="{% if coupon %}{{coupon.id}}{% endif %}"/>
            <label class="control-label">Image</label>
           	<div class="controls">
				<div id="couponimgupload" >
					<div class="fileupload-content">
						<ul class="files bm-uploader-list"></ul>
					</div><div class="clear"></div>
					{% csrf_token %}
					<div class="upload-button-wrapper">
						<a id="upload-button-wrapper" class="btn btn-primary fS12 fW-bLd">Add Image</a>
						<div class="fileinput-button">
							<input type="file" name="photo" id="id_photo" multiple=""  accept="image/*" tabindex="-1">
						</div>
					</div>
				</div>
			</div>
        </div>
    </form>	
</div>
{% upload_js %}
<script type="text/javascript">
var imageIsThere=false;
function file_upload_buz_coupon(url,limit,uploadTemplateId,downloadTemplateId) {
    'use strict';
    // Initialize the jQuery File Upload widget:
    $('#couponimgupload').fileupload({
       sequentialUploads:true,
       maxNumberOfFiles:limit,
       autoUpload:false,
       previewRequired:true,
       previewMaxWidth:200,
       previewMaxHeight:200,
       uploadTemplate:$('#'+uploadTemplateId),
       downloadTemplate:$('#'+downloadTemplateId),
       url:url,
       acceptFileTypes:/(\.|\/)(jpe?g|pjpeg|gif|png|x-png)$/i
    });
    {% if coupon %}get_coupon_images(url){% endif %}
    $('#couponimgupload .files a:not([target^=_blank])').live('click', function (e) {
        e.preventDefault();
        $('<iframe style="display:none;"></iframe>')
            .prop('src', this.href)
            .appendTo('body');
    });
}
function get_coupon_images(url){
    var noCache = Date();
    $.getJSON(url,{ "noCache": noCache },  function (files) {
        var fu = $('#couponimgupload').data('fileupload');
        fu._adjustMaxNumberOfFiles(-files.length);
        fu._renderDownload(files)
            .appendTo($('#couponimgupload .files'))
            .fadeIn(function () {
                // Fix for IE7 and lower:
                $(this).show();
            });
    });
}
var edt;
function updateTextArea(){
    CKEDITOR.tools.setTimeout( function(){ 
        $('#id_description').val(edt.getData());
        $("#id_description").trigger('keyup');
    }, 0);  
}
$(document).ready(function(){
    if($("#id_start_date").length){
        $("#id_start_date").datepicker({ dateFormat: "yy-mm-dd",minDate: new Date(),
            onSelect: function(){
                $(this).valid();
                enddate = $(this).val();
                splittedval = enddate.split('-');
                var date = new Date(splittedval[0], splittedval[1]-1, splittedval[2]);
                date.setDate(date.getDate() + 1);
                $("#id_end_date").datepicker( "option", "minDate", date );
            },
			beforeShow: function(input, obj) {
        		$(input).after($(input).datepicker('widget'));
    		}
        });
    }
    if($("#id_end_date").length){
        $("#id_end_date").datepicker({
            dateFormat: "yy-mm-dd",
            minDate: new Date(),
            onSelect: function(){
                $(this).valid();
            },
			 beforeShow: function(input, obj) {
        		$(input).after($(input).datepicker('widget'));
    		}
        });
    }
	
	$(".modal-body").scroll(function() {
    	$("#id_start_date").datepicker().datepicker('hide');
		$('#id_start_date').blur();
		$("#id_end_date").datepicker().datepicker('hide');
		$('#id_end_date').blur();
    });	

    file_upload_buz_coupon('{% url 'business_ajax_upload_coupon_photo' %}{% if coupon %}?pr_id={{coupon.id}}{% endif %}',1,'template-upload-p','template-download-p');
    $('#couponimgupload').bind('fileuploadadd', function (e, data) {imageIsThere=true;$('#upload-button-wrapper').hide(); 
        setTimeout(function(){
            $.browser.chrome = /chrome/.test(navigator.userAgent.toLowerCase()); 
            if (!$.browser.chrome && !$.browser.mozilla) {
                $('li.bm-uploader-file .img_name').show();
            }
        },500);
    });
    $('#couponimgupload').bind('fileuploadfail', function (e, data) {setTimeout(function(){imageIsThere=false;$('#upload-button-wrapper').show();},500);});
    $('#couponimgupload').bind('fileuploaddestroy', function (e, data) {setTimeout(function(){$('#upload-button-wrapper').show();},500);});
    
    $("#mform").validate({
        ignore:'',
        highlight: function(element, errorClass){
            if(element.id == 'id_description'){
                $(element).parent('div').addClass('error');
            }
            $(element).parent('div').parent('div').addClass('error');
            $(element).addClass('error');
        },
        unhighlight: function(element, errorClass){
            if(element.id == 'id_description'){
                $(element).parent('div').removeClass('error');
            }
            $(element).parent('div').parent('div').removeClass('error');
            $(element).removeClass('error');
        },
        errorPlacement: function(error, element){},
        rules:{
            title: "required",
            description: "required",
            start_date:"required dateISO",
            end_date:"required dateISO"
        }
    });
    try{
        var instance = CKEDITOR.instances['id_description'];
        CKEDITOR.remove(instance);
    }
    catch(e){}
    /*
    CKEDITOR.on( 'instanceCreated', function( e ){
        e.editor.addCss('body { font-size:12px; font-family:Arial, "Times New Roman", Verdana;}');
    });
    */
    edt=CKEDITOR.replace( 'id_description', {                   
        customConfig : '{{ STATIC_URL }}js/ckeditor/custome_config.js',
        toolbar : 'Basic' 
    });
    edt.on('key', function(event) {updateTextArea();});
});
</script>