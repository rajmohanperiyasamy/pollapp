{% extends "user_base.html" %}
{% load ds_utils %}
{% load tabs %}
{% load i18n %}
{% load thumbnail %}
{% block pagetitle %}{% if category %}{% seo_format_tag module='Business' title=category.seo_title code='LT' category=category.name as seo_meta_title %}{% else %}{% seo_format_tag module='Business' title=seo.seo_title code='MT' as seo_meta_title %}{% endif %}{{seo_meta_title}}{% endblock %}
{% block meta %}
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="description" content="{{seo.seo_description}}" />
{% endblock %}

{% block head %}
	<script type="text/javascript" src="{{ STATIC_URL }}js/common_user.js"></script>
<!-- CALENDER -->
<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}themes/green/css/LE_MetaId99.css">
<!-- CALENDER -->
<link type="text/css" rel="stylesheet" href="{{STATIC_URL}}css/bm.jfp.ui.css">
{% endblock %}

{% block navigation %}
	{% activetab "leftnav" "business" %}
	{{ block.super }}
{% endblock %}

{% block content %}
	            	<div class="span10 sP9mX979 sP12mX767">
		                <div class="row-fluid">
							<div class="main span9">
								<section class="sCn pD0">
									<div class="cLrFx pD20">
										<div class="pLlT">
											<h3 class="mR0 tRnCt">{{business.name}}</h3>
                                            <!--span class="fS11 cLr-gRy">{% for buzaddr in business.getaddress %}{{ buzaddr.address1 }}, {{buzaddr.zip}}{% endfor %}</span-->
										</div>
										<div class="pLrT w100pSmP mRt10SmP"><a href="{% url 'user_manage_business' %}" class="btn btn-small btn-light"><i aria-hidden="true" class="bUi-iCn-aRw-l-16"></i></a></div>
									</div>
                                    <div class="row-fluid">
                                    	<ul class="nav nav-tabs tB-cStM pLlT pD020 mR0">
                                            <li><a href="{% url 'user_update_business' business.id %}">Edit Business</a></li>
                                        	<li><a href="{% url 'user_business_images' business.id %}">Images</a></li>
                                    		<li><a href="{% url 'user_business_product' business.id %}">Product</a></li>
                                			<li class="active"><a href="{% url 'user_business_coupon' business.id %}">Coupons</a></li>
                                        </ul>	
                                    </div>
									<hr class="mRb12 mRt0">
                                    <div class="tLbR mRb12 pD015">
                                        <span class="help-block">Post your coupons and offers here and include a description, start & end date and upload a printable version of a coupon if you'd like.</span>
                                        <div class="tLbR-iR">
                                            <div class="pLrT">
                                                <a href="{%url 'user_business_coupon_add' business.id %}" data-id="0" class="btn btn-small btn-danger fW-bLd" data-target="#addCoupon"><span id="edit_icon_0">Add new coupon</span><span id="small_loading_icon_0" style="display: none;">Loading&nbsp;&nbsp;<i alt="Loading icon" class="icon-spinner bUi-iCn-sPnR mRr5 fS16" aria-hidden="true"></i></span></a>
                                            </div>
                                        </div>
                                    </div>
                                    <ul class="modulesBrowseData dSrS480 mDa-lT mDa-oT-lT oVrfLw-vSbL">
										<li class="table-list-row" style="text-align:center;padding:10px;display:none;" id="ajax_content_loading_list">
											<img src="{{STATIC_URL}}ui/images/global/loading-s.gif">
										</li>
							          	{% for coupon in coupons %}
                                        <li class="mDa mDa-sTtS-iN"  id="li_{{coupon.id}}">
                                            <div class="mDa-iN pDr15">
                                                <div class="mDa-wPr">
                                                    <span class="bUi-tMb-wPr tMb-75 dSpD  fLxiMgW bUi-tMb-110">
                                                        <span class="bUi-tMb w100pXmP">
                                                            <span class="bUi-tMb-pRpL">
                                                                <span class="bUi-tMb-cLp">
                                                                    <span class="bUi-tMb-cLp-iN">
                                                                        <img class="mDa-oT" src="{% if coupon.photo %}{% thumbnail coupon.photo 110x0 %}{% else %}{{STATIC_URL}}themes/green/images/global/nophoto_90.jpg{% endif %}" alt="{{coupon.title}}">
                                                                        <span class="vRtL-aLn">
                                                                        </span>
                                                                    </span>
                                                                </span>
                                                            </span>
                                                        </span>
                                                    </span>
                                                </div>
                                                <div class="mDa-bDy mRr0mP mRr0">
                                                    <h5 class="mDa-hD tRnCt0 mR50 rLvE h65" title = "{{coupon.title}}">
                                                        {{coupon.title}}/{% if coupon.type == 'C'%}{% trans 'Coupon' %}{% else%}{% trans 'Offer' %}{% endif %}
                                                    </h5>
													<p class="fS12 cLr-gRy">
                                                    	<span class="fS11 cLr-lTgRy">{% if coupon.start_date %}Starts {{coupon.start_date}}{% endif %}</span><span class="fS11 cLr-lTgRy sPrTr">Expires {{coupon.end_date}}</span>
                                                    </p>
                                                    <div class="clearfix">
                                                        <div class="btn-group pLlT iM">
                                                            <a href="{% url 'user_business_coupon_update' business.id coupon.id %}" title="Edit" data-id="{{coupon.id}}" data-target="#addCoupon" class="btn btn-light btn-small"><span id="edit_icon_{{coupon.id}}"><i aria-hidden="true" class="bUi-iCn-rVeW-12 ib"></i></span><span id="small_loading_icon_{{coupon.id}}" style="display: none;"><i alt="Loading icon" class="icon-spinner bUi-iCn-sPnR mRr5 fS16" aria-hidden="true"></i></span></a>
                                                            <button class="btn btn-light btn-small dropdown-toggle" data-toggle="dropdown">
                                                            <span class="caret"></span>
                                                            </button>
                                                            <ul class="dropdown-menu mNi pLrT dSpL">
                                                                <li>
                                                                    <a href="{% url 'user_business_coupon_update' business.id coupon.id %}" data-id="{{coupon.id}}" data-target="#addCoupon">Edit</a>
                                                                </li>
                                                                <li>
                                                                    <a href="javascript:delete_coupon({{coupon.id}})">Delete</a>
                                                                </li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </li>
										{% endfor %}
                                    </ul>
									<div class="no-data" style="{% if coupons %}display:none;{% endif %}">
										<!-- No data -->
										<div class="hT400 rLvE">
									 		<div class="tBl-bLk pDt0">
												<div class="tBl-cEl">
													<span class="iCn-bRdR80 oP25"><i aria-hidden="true" class="bUi-iCn-oFr-24 fS42-1 cLr-lTgRy ib"></i></span>
													<p class="bLk mRt20 fS16 cLr-lTgRy oP75">You haven't added any coupon yet.</p>
												</div>
											</div>
										</div>
										<!-- /No data -->
			                        </div>
								</section>
							</div> <!-- /.main -->
							<aside class="sD-bR span3">
								<div>
									<section class="tXt-cTr pD0 bNr-aD"> 
			                           
			                        </section>
								</div>
							</aside>
						</div>  <!-- /.row-fluid -->
					</div>  <!-- /.span10 -->


					<div id="addCoupon" class="modal hide fade mW40" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
			            <div class="modal-header">
			                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			                <h4 id="myModalLabel" class="mR50">Coupon Form</h4>
			            </div>
			            <div class="modal-body">
			            </div>
			            <div class="modal-footer">
			                <button class="btn btn-primary fS12 fW-bLd submit_button" onclick="save_coupon()" type="button">Save</button>
                            <button class="btn btn-primary fS12 fW-bLd hide submit_button" type="button" style="position: relative; pointer-events: none;"><i style="top: 7px; position: absolute;" alt="Loading icon" class="icon-spinner bUi-iCn-sPnR mRr5 fS16" aria-hidden="true"></i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Please wait! . . .</button>
			            </div>
			        </div>
<script type="text/javascript" src="{{ STATIC_URL }}js/jquery/jquery.ui.datepicker.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/jquery/jquery.validate.min.js"></script>
<script type="text/javascript" src="{{STATIC_URL}}js/ckeditor4/ckeditor.js"></script>
<script type="text/javascript" src="{{STATIC_URL}}js/jquery/bm.jfp.js"></script>
<script type="text/javascript" src="{{STATIC_URL}}js/jquery/bm.fup.appln.js"></script>
<script type="text/javascript">
		$(document).ready(function(){
			$("a[data-target=#addCoupon]").click(function(ev) {
               var pid = $(this).attr("data-id");
                clicked_btn = $(this);
                clicked_btn.css('pointer-events','none');
                $('#edit_icon_'+pid).hide();
                $('#small_loading_icon_'+pid).show();
			   ev.preventDefault();
			   target = $(this).attr("href");
			
			   // load the url and show modal on success
			   $("#addCoupon .modal-body").load(target, function() {
					$('#edit_icon_'+pid).show();
                    $('#small_loading_icon_'+pid).hide();
                    $("html, body").animate({scrollTop:0}, '200', function() {
                        $('#save_button_save').show(); 
                        $('#save_button_loading').hide();
                        $("#addCoupon").modal("show");
                        clicked_btn.css('pointer-events','auto');
                    });
			   });
			});
			$('#addCoupon').on('shown.bs.modal', function (e) {
				$("body").css("overflow", "hidden");
			})
			$('#addCoupon').on('hidden.bs.modal', function (e) {
				$("body").css("overflow", "auto");
			})
		});
function save_coupon(){
	var flag = $('#mform').validate().form()
	if(flag==true){
        $('.submit_button').toggleClass('hide');
		var dataString='&title='+encodeURIComponent($('#id_title').val());
		dataString+='&description='+encodeURIComponent(CKEDITOR.instances.id_description.getData());
		dataString+='&start_date='+encodeURIComponent($('#id_start_date').val());
		dataString+='&end_date='+encodeURIComponent($('#id_end_date').val());
		dataString+='&type='+$('input[name=type]:checked').val();
		$('#ajax_content_coupon').hide();
		$('#ajax_content_loading_coupon').show();
		$.ajax({
		type: "POST",
		url: $("#mform").attr("action"),
		data: dataString,
		dataType:'JSON',
		success: function(responseData){
				try{$('.no-data').hide();$('#add_head').show();}
				catch(e){}
				//$('#ajax_content_loading_coupon').html(responseData.msg);
				if(responseData.status){
					$("#coupon_id").val(responseData.id);
					if(imageIsThere){$(".start").trigger('click');}
					$('#addCoupon').modal('hide');
					try{$('#li_'+responseData.id).remove();}
					catch(e){}
                    $('#ajax_content_loading_list').show();
					setTimeout(function(){
                        location.reload(); 
                    },2500); 
					$("body").css("overflow", "auto");
				}else{
					$('div#ajax_content_coupon_outer').replaceWith(responseData.html);
					$('#addCoupon').modal('show');
                    $('.submit_button').toggleClass('hide');
				}
			}
		});
	}
}
function delete_coupon(id){
	if(confirm('Are you sure want to delete this coupon ?')){
		$.ajax({
			type: "POST",
			url:'{% url 'user_business_coupon_delete' %}',
			data:'id='+id,
			dataType:'JSON',
			success: function(responseData){
				if(responseData.status==1){
					$('#li_'+id).remove();
					if($('#coupon_list').find('li').length==1){
						$('.no-data').show();
						$('#add_head').hide();
					}
				}
			}
		});
	}
}
	
</script>
{% endblock %}